<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: Controles Corregidos</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; }
        #menu { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; }
        .btn { background: #4CAF50; color: white; border: none; padding: 15px 32px; font-size: 16px; margin: 10px; cursor: pointer; border-radius: 4px; }
        
        /* Controles Celular */
        #mobile-hud { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joystick-area { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #jump-btn { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; pointer-events: auto; border: 2px solid #fff; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 15px; height: 15px; border: 2px solid white; transform: translate(-50%, -50%); pointer-events: none; }
        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border: 2px solid white; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 1px solid #777; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; }
        .active { border: 3px solid #ffff00; background: rgba(255,255,0,0.2); }
    </style>
</head>
<body>

    <div id="menu">
        <h1>MINECRAFT JS</h1>
        <button class="btn" onclick="startGame(false)">MODO PC</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
    </div>

    <div id="mobile-hud">
        <div id="joystick-area"></div>
        <div id="jump-btn">SALTAR</div>
    </div>

    <div id="crosshair"></div>
    <div id="hotbar">
        <div id="s1" class="slot active" style="background: #2e7d32;" onclick="selectBlock(0x2e7d32, 's1')">TIERRA</div>
        <div id="s2" class="slot" style="background: #5d4037;" onclick="selectBlock(0x5d4037, 's2')">MADERA</div>
        <div id="s3" class="slot" style="background: #757575;" onclick="selectBlock(0x757575, 's3')">PIEDRA</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        let isMobile = false;
        let blocks = [];
        let selectedColor = 0x2e7d32;
        const playerSize = new THREE.Vector3(0.6, 1.8, 0.6);

        // --- INICIO ---
        window.startGame = (mobile) => {
            isMobile = mobile;
            document.getElementById('menu').style.display = 'none';
            if(isMobile) document.getElementById('mobile-hud').style.display = 'block';
            else controls.lock();
            animate();
        };

        window.selectBlock = (color, id) => {
            selectedColor = color;
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // --- ESCENA ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);

        // --- MUNDO (3x3 Chunks aprox) ---
        function createWorld() {
            for(let x = -10; x < 26; x++) {
                for(let z = -10; z < 26; z++) {
                    addBlock(x, 0, z, 0x2e7d32);
                }
            }
        }
        function addBlock(x, y, z, color) {
            const mesh = new THREE.Mesh(boxGeo, new THREE.MeshStandardMaterial({ color }));
            mesh.position.set(x, y, z);
            scene.add(mesh);
            blocks.push(mesh);
        }
        scene.add(new THREE.AmbientLight(0xffffff, 0.8), new THREE.DirectionalLight(0xffffff, 0.5));
        createWorld();
        camera.position.set(8, 3, 8);

        // --- COLISIONES ---
        function checkCollision(pos) {
            const pBox = new THREE.Box3().setFromCenterAndSize(
                pos.clone().sub(new THREE.Vector3(0, 0.9, 0)),
                playerSize
            );
            for (let b of blocks) {
                if (pBox.intersectsBox(new THREE.Box3().setFromObject(b))) return true;
            }
            return false;
        }

        // --- INTERACCIÓN ---
        window.addEventListener('mousedown', (e) => {
            if (!controls.isLocked && !isMobile) return;
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(), camera);
            const intersects = raycaster.intersectObjects(blocks);

            if (intersects.length > 0) {
                const intersect = intersects[0];
                if (e.button === 0) { // Romper
                    scene.remove(intersect.object);
                    blocks = blocks.filter(b => b !== intersect.object);
                } else if (e.button === 2 || (isMobile && e.button === 0)) { // Poner
                    const newPos = intersect.object.position.clone().add(intersect.face.normal);
                    const blockBox = new THREE.Box3().setFromCenterAndSize(newPos, new THREE.Vector3(1,1,1));
                    const playerBox = new THREE.Box3().setFromCenterAndSize(
                        camera.position.clone().sub(new THREE.Vector3(0, 0.9, 0)),
                        playerSize
                    );
                    if (!blockBox.intersectsBox(playerBox)) addBlock(newPos.x, newPos.y, newPos.z, selectedColor);
                }
            }
        });

        // --- MOVIMIENTO ---
        let keys = {};
        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        let velocityY = 0;
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            velocityY -= 25 * delta; // Gravedad

            if (controls.isLocked || isMobile) {
                const moveVec = new THREE.Vector3();
                if (keys['KeyW']) moveVec.z += 1; // Hacia adelante
                if (keys['KeyS']) moveVec.z -= 1; // Hacia atrás
                if (keys['KeyA']) moveVec.x -= 1; // Izquierda corregido
                if (keys['KeyD']) moveVec.x += 1; // Derecha corregido
                
                // Cálculo de direcciones basado en la cámara
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir); camDir.y = 0; camDir.normalize();
                
                // Vector lateral (Derecha): Producto cruzado entre dirección y arriba
                const camRight = new THREE.Vector3().crossVectors(camDir, camera.up).normalize();
                
                const nextPos = camera.position.clone();
                // Aplicar movimiento relativo corregido
                nextPos.addScaledVector(camDir, moveVec.z * 5 * delta);
                nextPos.addScaledVector(camRight, moveVec.x * 5 * delta);

                if (!checkCollision(nextPos)) {
                    camera.position.x = nextPos.x;
                    camera.position.z = nextPos.z;
                }

                // Salto y Gravedad
                camera.position.y += velocityY * delta;
                if (checkCollision(camera.position)) {
                    camera.position.y -= velocityY * delta;
                    velocityY = 0;
                    if (keys['Space']) velocityY = 10;
                }
            }
            renderer.render(scene, camera);
        }

        // Evento Salto Móvil
        document.getElementById('jump-btn').addEventListener('pointerdown', () => { if(velocityY === 0) velocityY = 10; });
    </script>
</body>
</html>