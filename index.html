<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <title>Minecraft JS: Tools & Nature + Multiplayer</title>
ย ย <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
ย ย <style>
ย ย ย ย body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; touch-action: none; }
ย ย ย ย #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
ย ย ย ยย
ย ย ย ย /* --- ESTILOS DE LA MIRA (CROSSHAIR) --- */
ย ย ย ย #crosshair {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย top: 50%;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย width: 20px;
ย ย ย ย ย ย height: 20px;
ย ย ย ย ย ย transform: translate(-50%, -50%);
ย ย ย ย ย ย pointer-events: none; /* Permite hacer clic a travรฉs de la cruz */
ย ย ย ย ย ย z-index: 9999;
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย }
ย ย ย ย .ch-line {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย background-color: rgba(255, 255, 255, 0.8);
ย ย ย ย ย ย box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
ย ย ย ย }
ย ย ย ย .ch-v { width: 2px; height: 100%; }
ย ย ย ย .ch-h { width: 100%; height: 2px; }
ย ย ย ย /* -------------------------------------- */

ย ย ย ย .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.85); pointer-events: auto; }
ย ย ย ย #m-hub { background: rgba(0,0,0,0.95); }
ย ย ย ย .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 8px; cursor: pointer; border-radius: 4px; width: 260px; font-weight: bold; border-bottom: 4px solid #2e7d32; }
ย ย ย ย .btn:active { border-bottom: 0; transform: translateY(2px); }
ย ย ย ย .btn-red { background: #f44336; border-bottom-color: #b71c1c; }
ย ย ย ย .btn-blue { background: #2196F3; border-bottom-color: #1565C0; }
ย ย ย ย .mod-row { margin: 8px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; width: 300px; justify-content: space-between; font-size: 13px; }
ย ย ย ย #creative-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 400px; background: #c6c6c6; border: 4px solid #373737; display: none; flex-direction: column; padding: 15px; z-index: 300; pointer-events: auto; color: #333; overflow-y: auto; }
ย ย ย ย #creative-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
ย ย ย ย .c-item { width: 60px; height: 60px; border: 3px solid #373737; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; text-align: center; font-weight: bold; }
ย ย ย ย .crafting-grid { display: grid; grid-template-columns: repeat(2, 55px); gap: 8px; background: #8b8b8b; padding: 10px; border: 2px solid #373737; }
ย ย ย ย .craft-slot { width: 55px; height: 55px; background: #8b8b8b; border: 3px solid #373737; cursor: pointer; color: #fff; font-size: 10px; text-align: center; display: flex; align-items: center; justify-content: center; }
ย ย ย ย #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
ย ย ย ย #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.2); }
ย ย ย ย #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
ย ย ย ย .m-btn { position: absolute; width: 65px; height: 65px; background: rgba(255,255,255,0.2); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid rgba(255,255,255,0.1); }
ย ย ย ย #m-mine { bottom: 130px; right: 130px; background: rgba(255, 0, 0, 0.3); }
ย ย ย ย #m-place { bottom: 130px; right: 40px; background: rgba(0, 120, 255, 0.3); }
ย ย ย ย #m-jump { bottom: 40px; right: 85px; width: 100px; height: 55px; background: rgba(255,255,255,0.3); }
ย ย ย ย #m-inv { top: 15px; left: 15px; width: 50px; height: 50px; background: #4CAF50; }
ย ย ย ย #m-mod { top: 15px; left: 75px; width: 50px; height: 50px; background: #ff9800; }
ย ย ย ย #m-cre { top: 80px; left: 15px; width: 50px; height: 50px; background: #2196F3; }
ย ย ย ย #inventory-panel { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); width: 240px; background: #c6c6c6; border: 4px solid #373737; display: none; flex-direction: column; align-items: center; padding: 12px; z-index: 200; pointer-events: auto; }
ย ย ย ย #craft-result { width: 60px; height: 60px; background: #999; border: 4px solid #373737; margin-top: 10px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; cursor: pointer; }
ย ย ย ย #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.7); padding: 5px; border: 3px solid #555; pointer-events: auto; }
ย ย ย ย .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; background: rgba(255,255,255,0.1); cursor: pointer; }
ย ย ย ย .slot.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
ย ย ย ย #break-indicator { position: absolute; top: 50%; left: 50%; width: 22px; height: 22px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
ย ย </style>
</head>
<body>
ย ย <div id="crosshair">
ย ย ย ย <div class="ch-line ch-v"></div>
ย ย ย ย <div class="ch-line ch-h"></div>
ย ย </div>

ย ย <div id="break-indicator"></div>
ย ย <div id="menu" class="full-overlay" style="display: flex;">
ย ย ย ย <h1>MINECRAFT JS: TOOLS</h1>
ย ย ย ย <button class="btn" onclick="startGame(false)">MODO PC</button>
ย ย ย ย <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
ย ย </div>
ย ยย
ย ย <div id="m-hub" class="full-overlay">
ย ย ย ย <h2>CENTRO DE CONTROL (M)</h2>
ย ย ย ย <div id="mp-status" style="font-size: 12px; color: #aaa; margin-bottom: 10px;">ID Mi Dispositivo: ...</div>
ย ย ย ย <button class="btn btn-blue" onclick="openSubMenu('mp-menu')">๐ MULTIJUGADOR</button>
ย ย ย ย <button class="btn" onclick="openSubMenu('obj-editor')">๐๏ธ CREAR NUEVO OBJETO</button>
ย ย ย ย <button class="btn" onclick="openSubMenu('mod-menu-inner')">๐ MENร DE MODS</button>
ย ย ย ย <button class="btn btn-red" onclick="closeAllMenus()">CERRAR [M]</button>
ย ย </div>

ย ย <div id="mp-menu" class="full-overlay">
ย ย ย ย <h2>MULTIJUGADOR P2P</h2>
ย ย ย ย <div class="mod-row">Tu Cรณdigo: <b id="my-code-display">Cargando...</b></div>
ย ย ย ย <hr style="width: 80%; opacity: 0.2;">
ย ย ย ย <input type="text" id="join-code" placeholder="Cรณdigo del servidor..." style="padding:10px; margin:5px; width: 240px; text-align: center;">
ย ย ย ย <button class="btn" onclick="joinServer()">ENTRAR A SERVER</button>
ย ย ย ย <button class="btn btn-red" onclick="openSubMenu('m-hub')">VOLVER</button>
ย ย </div>

ย ย <div id="creative-panel">
ย ย ย ย <h3 style="margin-top:0">MODO CREATIVO</h3>
ย ย ย ย <div id="creative-list"></div>
ย ย ย ย <button class="btn btn-red" style="width:100%; margin: 10px 0 0 0;" onclick="toggleCreative()">CERRAR [T]</button>
ย ย </div>

ย ย <div id="obj-editor" class="full-overlay">
ย ย ย ย <h2>CREADOR DE รTEMS</h2>
ย ย ย ย <input type="text" id="obj-name" placeholder="Nombre..." style="padding:10px; margin:5px;">
ย ย ย ย <div class="mod-row">Tipo:ย
ย ย ย ย ย ย <select id="obj-type" style="padding:5px;">
ย ย ย ย ย ย ย ย <option value="block">Bloque</option>
ย ย ย ย ย ย ย ย <option value="tool">Pico (Herramienta)</option>
ย ย ย ย ย ย </select>
ย ย ย ย </div>
ย ย ย ย <div class="mod-row">Color: <input type="color" id="obj-color" value="#ffffff"></div>
ย ย ย ย <div class="mod-row">Dureza/Poder: <input type="range" id="obj-hard" min="0" max="10" step="0.5" value="2" oninput="updateHardText(this.value)"> <span id="hard-val">2s</span></div>
ย ย ย ย <div class="crafting-grid">
ย ย ย ย ย ย <div class="craft-slot" id="e0" onclick="cycleEditMat(this)" data-mat="null">VACรO</div>
ย ย ย ย ย ย <div class="craft-slot" id="e1" onclick="cycleEditMat(this)" data-mat="null">VACรO</div>
ย ย ย ย ย ย <div class="craft-slot" id="e2" onclick="cycleEditMat(this)" data-mat="null">VACรO</div>
ย ย ย ย ย ย <div class="craft-slot" id="e3" onclick="cycleEditMat(this)" data-mat="null">VACรO</div>
ย ย ย ย </div>
ย ย ย ย <button class="btn" onclick="saveCustomObject()">๐พ GUARDAR</button>
ย ย ย ย <button class="btn btn-red" onclick="openSubMenu('m-hub')">CANCELAR</button>
ย ย </div>

ย ย <div id="mod-menu-inner" class="full-overlay">
ย ย ย ย <h2>MODS</h2>
ย ย ย ย <div class="mod-row">Creativo Inf: <input type="checkbox" id="mod-creative-inf"></div>
ย ย ย ย <div class="mod-row">Vuelo: <input type="checkbox" id="mod-fly" onchange="updateMods()"></div>
ย ย ย ย <div class="mod-row">Velocidad: <input type="range" id="mod-speed" min="1" max="30" value="6" oninput="updateMods()"></div>
ย ย ย ย <button class="btn" onclick="openSubMenu('m-hub')">VOLVER</button>
ย ย </div>

ย ย <div id="mobile-controls">
ย ย ย ย <div id="joystick-container"><div id="joystick-knob"></div></div>
ย ย ย ย <div class="m-btn" id="m-mine">MINAR</div>
ย ย ย ย <div class="m-btn" id="m-place">PONER</div>
ย ย ย ย <div class="m-btn" id="m-jump">SALTAR</div>
ย ย ย ย <div class="m-btn" id="m-inv">INV</div>
ย ย ย ย <div class="m-btn" id="m-mod">M</div>
ย ย ย ย <div class="m-btn" id="m-cre">T</div>
ย ย </div>

ย ย <div id="inventory-panel">
ย ย ย ย <div class="crafting-grid" id="main-craft-grid">
ย ย ย ย ย ย <div id="c0" class="craft-slot" onclick="tapToCraft(0)"></div>
ย ย ย ย ย ย <div id="c1" class="craft-slot" onclick="tapToCraft(1)"></div>
ย ย ย ย ย ย <div id="c2" class="craft-slot" onclick="tapToCraft(2)"></div>
ย ย ย ย ย ย <div id="c3" class="craft-slot" onclick="tapToCraft(3)"></div>
ย ย ย ย </div>
ย ย ย ย <div id="craft-result" onclick="finishCraft()">CRAFTEAR</div>
ย ย </div>

ย ย <div id="ui-layer">
ย ย ย ย <div id="hotbar">
ย ย ย ย ย ย <div id="s0" class="slot active" data-color="null" data-count="0" onclick="updateActiveSlot(0)">1</div>
ย ย ย ย ย ย <div id="s1" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(1)">2</div>
ย ย ย ย ย ย <div id="s2" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(2)">3</div>
ย ย ย ย ย ย <div id="s3" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(3)">4</div>
ย ย ย ย ย ย <div id="s4" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(4)">5</div>
ย ย ย ย </div>
ย ย </div>

ย ย <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
ย ย <script type="module">
ย ย ย ย /* El script permanece igual, no necesita cambios */
ย ย ย ย import * as THREE from 'three';
ย ย ย ย import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

ย ย ย ย let blocks = [], isMobile = false, activeSlot = 0;
ย ย ย ย let isInventoryOpen = false, isAnyMOpen = false, isCreativeOpen = false;
ย ย ย ย let velocityY = 0, isGrounded = false, keys = {};
ย ย ย ย let config = { gravity: 28, speed: 6, fly: false, sensitivity: 0.002, fov: 80 };
ย ย ย ย let isMining = false, mineProgress = 0, currentTarget = null;

ย ย ย ย // MULTIPLAYER LOGIC
ย ย ย ย let peer, connections = [], remotePlayers = {};
ย ย ย ย const playerGeo = new THREE.SphereGeometry(0.4, 16, 16);
ย ย ย ย const playerMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });

ย ย ย ย function initMultiplayer() {
ย ย ย ย ย ย peer = new Peer();ย
ย ย ย ย ย ย peer.on('open', (id) => {
ย ย ย ย ย ย ย ย document.getElementById('mp-status').innerText = "ID Dispositivo: " + id;
ย ย ย ย ย ย ย ย document.getElementById('my-code-display').innerText = id;
ย ย ย ย ย ย });
ย ย ย ย ย ย peer.on('connection', (conn) => {
ย ย ย ย ย ย ย ย setupConnection(conn);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function setupConnection(conn) {
ย ย ย ย ย ย conn.on('open', () => {
ย ย ย ย ย ย ย ย connections.push(conn);
ย ย ย ย ย ย ย ย const pMesh = new THREE.Mesh(playerGeo, playerMat);
ย ย ย ย ย ย ย ย scene.add(pMesh);
ย ย ย ย ย ย ย ย remotePlayers[conn.peer] = pMesh;
ย ย ย ย ย ย });
ย ย ย ย ย ย conn.on('data', (data) => {
ย ย ย ย ย ย ย ย if(data.type === 'move' && remotePlayers[conn.peer]) {
ย ย ย ย ย ย ย ย ย ย remotePlayers[conn.peer].position.set(data.x, data.y, data.z);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย if(data.type === 'place') {
ย ย ย ย ย ย ย ย ย ย const newB = addBlock(data.x, data.y, data.z, data.color);
ย ย ย ย ย ย ย ย ย ย scene.add(newB);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย ย ย conn.on('close', () => {
ย ย ย ย ย ย ย ย if(remotePlayers[conn.peer]) scene.remove(remotePlayers[conn.peer]);
ย ย ย ย ย ย ย ย delete remotePlayers[conn.peer];
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย window.joinServer = () => {
ย ย ย ย ย ย const code = document.getElementById('join-code').value.trim();
ย ย ย ย ย ย if(!code) return alert("Introduce un cรณdigo");
ย ย ย ย ย ย const conn = peer.connect(code);
ย ย ย ย ย ย setupConnection(conn);
ย ย ย ย ย ย closeAllMenus();
ย ย ย ย };

ย ย ย ย function broadcastMove() {
ย ย ย ย ย ย if(connections.length === 0) return;
ย ย ย ย ย ย const pos = { type: 'move', x: camera.position.x, y: camera.position.y - 0.5, z: camera.position.z };
ย ย ย ย ย ย connections.forEach(c => c.send(pos));
ย ย ย ย }

ย ย ย ย function broadcastPlace(x, y, z, color) {
ย ย ย ย ย ย connections.forEach(c => c.send({ type: 'place', x, y, z, color }));
ย ย ย ย }

ย ย ย ย let hardness = { "2e7d32": 0.4, "795548": 0.5, "5d4037": 1.2, "388e3c": 0.2, "9e9e9e": 2.5, "1a1a1a": Infinity };
ย ย ย ย let tools = { "wooden_pick": 2.5, "diamond_pick": 10.0 };
ย ย ย ยย
ย ย ย ย const catalog = [
ย ย ย ย ย ย {name:"Pasto",color:0x2e7d32, type:"block"},
ย ย ย ย ย ย {name:"Tierra",color:0x795548, type:"block"},
ย ย ย ย ย ย {name:"Madera",color:0x5d4037, type:"block"},
ย ย ย ย ย ย {name:"Hojas",color:0x388e3c, type:"block"},
ย ย ย ย ย ย {name:"Piedra",color:0x9e9e9e, type:"block"},
ย ย ย ย ย ย {name:"Bedrock",color:0x1a1a1a, type:"block"},
ย ย ย ย ย ย {name:"Pico Madera", color:0x8B4513, type:"tool", power: 2.5}
ย ย ย ย ];

ย ย ย ย const CHUNK_SIZE = 12;
ย ย ย ย const RENDER_DISTANCE = 1;ย
ย ย ย ย const chunks = new Map();
ย ย ย ย let currentChunkCoords = { x: 999, z: 999 };
ย ย ย ย const blockBox = new THREE.BoxGeometry(1, 1, 1);

ย ย ย ย const scene = new THREE.Scene();ย
ย ย ย ย scene.background = new THREE.Color(0x87ceeb);
ย ย ย ย const camera = new THREE.PerspectiveCamera(config.fov, window.innerWidth/window.innerHeight, 0.1, 500);
ย ย ย ย const renderer = new THREE.WebGLRenderer({ antialias: false });
ย ย ย ย renderer.setSize(window.innerWidth, window.innerHeight);
ย ย ย ย document.body.appendChild(renderer.domElement);
ย ย ย ย const controls = new PointerLockControls(camera, document.body);

ย ย ย ย function addBlock(x, y, z, color) {
ย ย ย ย ย ย const m = new THREE.Mesh(blockBox, new THREE.MeshStandardMaterial({ color }));
ย ย ย ย ย ย m.position.set(x, y, z);
ย ย ย ย ย ย m.matrixAutoUpdate = false; m.updateMatrix();
ย ย ย ย ย ย scene.add(m);
ย ย ย ย ย ย blocks.push(m);
ย ย ย ย ย ย return m;
ย ย ย ย }

ย ย ย ย function spawnTree(x, y, z, group) {
ย ย ย ย ย ย const trunkHeight = 3 + Math.floor(Math.random()*2);
ย ย ย ย ย ย for(let i=1; i<=trunkHeight; i++) {
ย ย ย ย ย ย ย ย group.add(addBlock(x, y+i, z, 0x5d4037));
ย ย ย ย ย ย }
ย ย ย ย ย ย for(let ox=-1; ox<=1; ox++) {
ย ย ย ย ย ย ย ย for(let oz=-1; oz<=1; oz++) {
ย ย ย ย ย ย ย ย ย ย for(let oy=0; oy<2; oy++) {
ย ย ย ย ย ย ย ย ย ย ย ย group.add(addBlock(x+ox, y+trunkHeight+oy, z+oz, 0x388e3c));
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย async function generateChunk(cx, cz) {
ย ย ย ย ย ย const key = `${cx},${cz}`;
ย ย ย ย ย ย if (chunks.has(key)) return;
ย ย ย ย ย ย const chunkGroup = new THREE.Group();
ย ย ย ย ย ย chunks.set(key, chunkGroup);
ย ย ย ย ย ย scene.add(chunkGroup);
ย ย ย ย ย ย for(let x = 0; x < CHUNK_SIZE; x++) {
ย ย ย ย ย ย ย ย for(let z = 0; z < CHUNK_SIZE; z++) {
ย ย ย ย ย ย ย ย ย ย const worldX = cx * CHUNK_SIZE + x;
ย ย ย ย ย ย ย ย ย ย const worldZ = cz * CHUNK_SIZE + z;
ย ย ย ย ย ย ย ย ย ย const h = Math.round(Math.sin(worldX/10)*Math.cos(worldZ/10) * 3);
ย ย ย ย ย ย ย ย ย ย chunkGroup.add(addBlock(worldX, h, worldZ, 0x2e7d32));
ย ย ย ย ย ย ย ย ย ย chunkGroup.add(addBlock(worldX, h-1, worldZ, 0x795548));
ย ย ย ย ย ย ย ย ย ย if(Math.random() < 0.015 && x > 1 && x < CHUNK_SIZE-2) {
ย ย ย ย ย ย ย ย ย ย ย ย spawnTree(worldX, h, worldZ, chunkGroup);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย if(x % 4 === 0) await new Promise(r => setTimeout(r, 0));
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function updateChunks() {
ย ย ย ย ย ย const cx = Math.floor(camera.position.x / CHUNK_SIZE);
ย ย ย ย ย ย const cz = Math.floor(camera.position.z / CHUNK_SIZE);
ย ย ย ย ย ย if (cx !== currentChunkCoords.x || cz !== currentChunkCoords.z) {
ย ย ย ย ย ย ย ย currentChunkCoords = { x: cx, z: cz };
ย ย ย ย ย ย ย ย for (let x = cx - RENDER_DISTANCE; x <= cx + RENDER_DISTANCE; x++) {
ย ย ย ย ย ย ย ย ย ย for (let z = cz - RENDER_DISTANCE; z <= cz + RENDER_DISTANCE; z++) {
ย ย ย ย ย ย ย ย ย ย ย ย generateChunk(x, z);
ย ย ย ย ย ย ย ย ย ย ย ย if (chunks.has(`${x},${z}`)) chunks.get(`${x},${z}`).visible = true;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย for (let [key, group] of chunks) {
ย ย ย ย ย ย ย ย ย ย const [kx, kz] = key.split(',').map(Number);
ย ย ย ย ย ย ย ย ย ย if (Math.abs(kx - cx) > RENDER_DISTANCE || Math.abs(kz - cz) > RENDER_DISTANCE) {
ย ย ย ย ย ย ย ย ย ย ย ย group.visible = false;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย scene.add(new THREE.AmbientLight(0xffffff, 0.8), new THREE.DirectionalLight(0xffffff, 0.4));
ย ย ย ย camera.position.set(5, 12, 5);

ย ย ย ย window.handlePlace = () => {
ย ย ย ย ย ย const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
ย ย ย ย ย ย const hits = ray.intersectObjects(blocks.filter(b => b.parent && b.parent.visible), false);
ย ย ย ย ย ย if(hits.length > 0 && hits[0].distance < 5) {
ย ย ย ย ย ย ย ย const s = document.querySelectorAll('.slot')[activeSlot];
ย ย ย ย ย ย ย ย if(s.dataset.color !== "null" && s.dataset.type === "block") {
ย ย ย ย ย ย ย ย ย ย const pos = hits[0].object.position.clone().add(hits[0].face.normal);
ย ย ย ย ย ย ย ย ย ย const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(camera.position.x, camera.position.y-0.9, camera.position.z), new THREE.Vector3(0.6, 1.8, 0.6));
ย ย ย ย ย ย ย ย ย ย const bBox = new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(0.9, 0.9, 0.9));
ย ย ย ย ย ย ย ย ย ย if(!pBox.intersectsBox(bBox)) {
ย ย ย ย ย ย ย ย ย ย ย ย const colorInt = parseInt(s.dataset.color);
ย ย ย ย ย ย ย ย ย ย ย ย const newB = addBlock(pos.x, pos.y, pos.z, colorInt);
ย ย ย ย ย ย ย ย ย ย ย ย hits[0].object.parent.add(newB);
ย ย ย ย ย ย ย ย ย ย ย ย broadcastPlace(pos.x, pos.y, pos.z, colorInt);ย
ย ย ย ย ย ย ย ย ย ย ย ย if(!document.getElementById('mod-creative-inf').checked) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย let c = parseInt(s.dataset.count) - 1;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย s.dataset.count = c; s.innerText = c > 0 ? c : activeSlot+1;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if(c <= 0) { s.dataset.color = "null"; s.style.backgroundColor = "rgba(255,255,255,0.1)"; }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย const clock = new THREE.Clock();
ย ย ย ย function animate() {
ย ย ย ย ย ย requestAnimationFrame(animate);
ย ย ย ย ย ย const delta = Math.min(clock.getDelta(), 0.1);
ย ย ย ย ย ย updateChunks();
ย ย ย ย ย ย broadcastMove();ย

ย ย ย ย ย ย if(isMining) {
ย ย ย ย ย ย ย ย const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
ย ย ย ย ย ย ย ย const hits = ray.intersectObjects(blocks.filter(b => b.parent && b.parent.visible), false);
ย ย ย ย ย ย ย ย if(hits.length > 0 && hits[0].distance < 4.5) {
ย ย ย ย ย ย ย ย ย ย const b = hits[0].object;
ย ย ย ย ย ย ย ย ย ย const hex = b.material.color.getHexString().toLowerCase();
ย ย ย ย ย ย ย ย ย ย if(hardness[hex] !== Infinity) {
ย ย ย ย ย ย ย ย ย ย ย ย if(currentTarget !== b) { currentTarget = b; mineProgress = 0; }
ย ย ย ย ย ย ย ย ย ย ย ย const s = document.querySelectorAll('.slot')[activeSlot];
ย ย ย ย ย ย ย ย ย ย ย ย let power = (s.dataset.type === "tool") ? parseFloat(s.dataset.power) : 1;
ย ย ย ย ย ย ย ย ย ย ย ย mineProgress += delta * power;
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('break-indicator').style.display = 'block';
ย ย ย ย ย ย ย ย ย ย ย ย if(mineProgress >= (hardness[hex] || 1)) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย addToInventory(b.material.color.getHex(), 1, "block");
ย ย ย ย ย ย ย ย ย ย ย ย ย ย b.parent.remove(b); blocks = blocks.filter(x => x !== b); resetMining();
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } else resetMining();
ย ย ย ย ย ย }

ย ย ย ย ย ย if((controls.isLocked || isMobile) && !isInventoryOpen && !isAnyMOpen && !isCreativeOpen) {
ย ย ย ย ย ย ย ย if(!config.fly) velocityY -= config.gravity * delta;
ย ย ย ย ย ย ย ย const moveVec = new THREE.Vector3();
ย ย ย ย ย ย ย ย if(isMobile) { moveVec.z = -joyDir.y; moveVec.x = joyDir.x; }
ย ย ย ย ย ย ย ย else { if(keys['KeyW']) moveVec.z += 1; if(keys['KeyS']) moveVec.z -= 1; if(keys['KeyA']) moveVec.x -= 1; if(keys['KeyD']) moveVec.x += 1; }
ย ย ย ย ย ย ย ย const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
ย ย ย ย ย ย ย ย const right = new THREE.Vector3().crossVectors(dir, camera.up).normalize();
ย ย ย ย ย ย ย ย const nextX = camera.position.clone().addScaledVector(dir, moveVec.z * config.speed * delta).addScaledVector(right, moveVec.x * config.speed * delta);
ย ย ย ย ย ย ย ย if(!checkCollisions(new THREE.Vector3(nextX.x, camera.position.y, camera.position.z))) camera.position.x = nextX.x;
ย ย ย ย ย ย ย ย if(!checkCollisions(new THREE.Vector3(camera.position.x, camera.position.y, nextX.z))) camera.position.z = nextX.z;
ย ย ย ย ย ย ย ย if(!config.fly) {
ย ย ย ย ย ย ย ย ย ย const nextY = camera.position.clone(); nextY.y += velocityY * delta;
ย ย ย ย ย ย ย ย ย ย if(!checkCollisions(nextY)) { camera.position.y = nextY.y; isGrounded = false; }
ย ย ย ย ย ย ย ย ย ย else { if(velocityY < 0) isGrounded = true; velocityY = 0; }
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย if(keys['Space']) camera.position.y += 0.2;
ย ย ย ย ย ย ย ย ย ย if(keys['ShiftLeft']) camera.position.y -= 0.2;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย renderer.render(scene, camera);
ย ย ย ย }

ย ย ย ย function checkCollisions(pos) {
ย ย ย ย ย ย const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(pos.x, pos.y-0.9, pos.z), new THREE.Vector3(0.5, 1.8, 0.5));
ย ย ย ย ย ย for(let i=0; i<blocks.length; i++) {
ย ย ย ย ย ย ย ย const b = blocks[i];
ย ย ย ย ย ย ย ย if(b.parent && b.parent.visible && Math.abs(b.position.x - pos.x) < 1.5 && Math.abs(b.position.z - pos.z) < 1.5) {
ย ย ย ย ย ย ย ย ย ย if(pBox.intersectsBox(new THREE.Box3().setFromObject(b))) return true;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย return false;
ย ย ย ย }

ย ย ย ย window.addToInventory = (color, count = 1, type = "block", power = 1) => {
ย ย ย ย ย ย const slots = document.querySelectorAll('.slot');
ย ย ย ย ย ย let t = Array.from(slots).find(s => parseInt(s.dataset.color) === color && s.dataset.type === type) || Array.from(slots).find(s => s.dataset.color === "null");
ย ย ย ย ย ย if(t) {
ย ย ย ย ย ย ย ย let current = (parseInt(t.dataset.count) || 0);
ย ย ย ย ย ย ย ย t.dataset.color = color;ย
ย ย ย ย ย ย ย ย t.dataset.count = current + count;
ย ย ย ย ย ย ย ย t.dataset.type = type;
ย ย ย ย ย ย ย ย t.dataset.power = power;
ย ย ย ย ย ย ย ย t.style.backgroundColor = "#" + color.toString(16).padStart(6,'0');
ย ย ย ย ย ย ย ย t.innerText = t.dataset.type === "tool" ? "โ๏ธ" : t.dataset.count;
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.tapToCraft = (idx) => {
ย ย ย ย ย ย const s = document.querySelectorAll('.slot')[activeSlot];
ย ย ย ย ย ย if(s.dataset.color !== "null") {
ย ย ย ย ย ย ย ย const el = document.getElementById('c'+idx);
ย ย ย ย ย ย ย ย el.style.backgroundColor = s.style.backgroundColor;ย
ย ย ย ย ย ย ย ย el.dataset.color = s.dataset.color;
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.finishCraft = () => {
ย ย ย ย ย ย const craftSlots = document.querySelectorAll('#main-craft-grid .craft-slot');
ย ย ย ย ย ย if(Array.from(craftSlots).some(s => s.dataset.color !== "null")) {
ย ย ย ย ย ย ย ย addToInventory(catalog[catalog.length-1].color, 1, catalog[catalog.length-1].type, catalog[catalog.length-1].power);
ย ย ย ย ย ย ย ย craftSlots.forEach(s => { s.style.backgroundColor="#8b8b8b"; s.dataset.color="null"; });
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.updateHardText = (v) => { document.getElementById('hard-val').innerText = v + "x"; };
ย ย ย ย window.cycleEditMat = (el) => {
ย ย ย ย ย ย const mats = [{n:"VACรO",c:"null"}, {n:"PASTO",c:"0x2e7d32"}, {n:"MADERA",c:"0x5d4037"}, {n:"PIEDRA",c:"0x9e9e9e"}];
ย ย ย ย ย ย let idx = mats.findIndex(m => m.c === el.dataset.mat);
ย ย ย ย ย ย let next = mats[(idx + 1) % mats.length];
ย ย ย ย ย ย el.dataset.mat = next.c; el.innerText = next.n;
ย ย ย ย ย ย el.style.backgroundColor = (next.c !== "null") ? "#" + parseInt(next.c).toString(16).padStart(6,'0') : "#8b8b8b";
ย ย ย ย };

ย ย ย ย window.saveCustomObject = () => {
ย ย ย ย ย ย const colorHex = document.getElementById('obj-color').value;
ย ย ย ย ย ย const type = document.getElementById('obj-type').value;
ย ย ย ย ย ย const val = parseFloat(document.getElementById('obj-hard').value);
ย ย ย ย ย ย const colorInt = parseInt(colorHex.replace('#','0x'));
ย ย ย ย ย ย catalog.push({ name: document.getElementById('obj-name').value || "รtem", color: colorInt, type: type, power: val });
ย ย ย ย ย ย if(type === "block") hardness[colorHex.replace('#','').toLowerCase()] = val;
ย ย ย ย ย ย openSubMenu('m-hub');
ย ย ย ย };

ย ย ย ย window.toggleCreative = () => {
ย ย ย ย ย ย isCreativeOpen = !isCreativeOpen; document.getElementById('creative-panel').style.display = isCreativeOpen ? 'flex' : 'none';
ย ย ย ย ย ย if(isCreativeOpen) { renderCreativeList(); if(!isMobile) controls.unlock(); } else if(!isMobile) controls.lock();
ย ย ย ย };

ย ย ย ย function renderCreativeList() {
ย ย ย ย ย ย const list = document.getElementById('creative-list'); list.innerHTML = "";
ย ย ย ย ย ย catalog.forEach(item => {
ย ย ย ย ย ย ย ย const div = document.createElement('div'); div.className = 'c-item';
ย ย ย ย ย ย ย ย div.style.backgroundColor = "#" + item.color.toString(16).padStart(6, '0');
ย ย ย ย ย ย ย ย div.innerText = item.name;ย
ย ย ย ย ย ย ย ย div.onclick = () => addToInventory(item.color, 64, item.type, item.power || 1);ย
ย ย ย ย ย ย ย ย list.appendChild(div);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function resetMining() { currentTarget = null; isMining = false; document.getElementById('break-indicator').style.display = 'none'; }
ย ย ย ย window.startGame = (m) => {ย
ย ย ย ย ย ย isMobile = m;ย
ย ย ย ย ย ย document.getElementById('menu').style.display='none';ย
ย ย ย ย ย ย if(m) document.getElementById('mobile-controls').style.display='block'; else controls.lock();ย
ย ย ย ย ย ย initMultiplayer();ย
ย ย ย ย ย ย animate();ย
ย ย ย ย };
ย ย ย ย window.openSubMenu = (id) => { isAnyMOpen = true; document.querySelectorAll('.full-overlay').forEach(el => el.style.display = 'none'); document.getElementById(id).style.display = 'flex'; if(!isMobile) controls.unlock(); };
ย ย ย ย window.closeAllMenus = () => { isAnyMOpen = false; document.querySelectorAll('.full-overlay').forEach(el => el.style.display = 'none'); if(!isMobile) controls.lock(); };
ย ย ย ย window.toggleInventory = () => { isInventoryOpen = !isInventoryOpen; document.getElementById('inventory-panel').style.display = isInventoryOpen ? 'flex' : 'none'; if(!isMobile) isInventoryOpen ? controls.unlock() : controls.lock(); };
ย ย ย ย window.updateActiveSlot = (i) => { activeSlot = i; document.querySelectorAll('.slot').forEach((s,idx) => s.classList.toggle('active', idx === i)); };
ย ย ย ย window.updateMods = () => { config.speed = parseFloat(document.getElementById('mod-speed').value); config.fly = document.getElementById('mod-fly').checked; };

ย ย ย ย window.addEventListener('mousedown', (e) => { if(controls.isLocked) { if(e.button===0) isMining=true; if(e.button===2) handlePlace(); }});
ย ย ย ย window.addEventListener('mouseup', resetMining);
ย ย ย ย window.addEventListener('keydown', e => {ย
ย ย ย ย ย ย keys[e.code] = true;ย
ย ย ย ย ย ย if (['1','2','3','4','5'].includes(e.key)) updateActiveSlot(parseInt(e.key) - 1);
ย ย ย ย ย ย if(e.key.toLowerCase()==='m') isAnyMOpen ? closeAllMenus() : openSubMenu('m-hub');ย
ย ย ย ย ย ย if(e.key.toLowerCase()==='e') toggleInventory();
ย ย ย ย ย ย if(e.key.toLowerCase()==='t') toggleCreative();
ย ย ย ย ย ย if(e.code==='Space' && (isGrounded || config.fly)) velocityY = 11;
ย ย ย ย });
ย ย ย ย window.addEventListener('keyup', e => keys[e.code] = false);

ย ย ย ย document.getElementById('m-mine').ontouchstart = (e) => { e.preventDefault(); isMining = true; };
ย ย ย ย document.getElementById('m-mine').ontouchend = resetMining;
ย ย ย ย document.getElementById('m-place').onclick = handlePlace;
ย ย ย ย document.getElementById('m-jump').onclick = () => { if(isGrounded || config.fly) velocityY = 11; };
ย ย ย ย document.getElementById('m-mod').onclick = () => isAnyMOpen ? closeAllMenus() : openSubMenu('m-hub');
ย ย ย ย document.getElementById('m-cre').onclick = toggleCreative;
ย ย ย ย document.getElementById('m-inv').onclick = toggleInventory;

ย ย ย ย let joyDir = { x: 0, y: 0 }, touchX = 0, touchY = 0;
ย ย ย ย document.getElementById('joystick-container').addEventListener('touchmove', e => {
ย ย ย ย ย ย const rect = e.currentTarget.getBoundingClientRect();
ย ย ย ย ย ย const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
ย ย ย ย ย ย const dist = Math.min(Math.sqrt(x*x + y*y), 45), angle = Math.atan2(y, x);
ย ย ย ย ย ย joyDir = { x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45 };
ย ย ย ย ย ย document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
ย ย ย ย });
ย ย ย ย document.getElementById('joystick-container').addEventListener('touchend', () => { joyDir = {x:0,y:0}; document.getElementById('joystick-knob').style.transform = 'translate(0,0)'; });

ย ย ย ย window.addEventListener('touchstart', e => { if(isMobile && e.touches[0].pageX > window.innerWidth/2) { touchX = e.touches[0].pageX; touchY = e.touches[0].pageY; }});
ย ย ย ย window.addEventListener('touchmove', e => {
ย ย ย ย ย ย if(isMobile && !isInventoryOpen && !isAnyMOpen && !isCreativeOpen && e.touches[0].pageX > window.innerWidth/2) {
ย ย ย ย ย ย ย ย camera.rotation.y -= (e.touches[0].pageX - touchX) * config.sensitivity;
ย ย ย ย ย ย ย ย camera.rotation.x -= (e.touches[0].pageY - touchY) * config.sensitivity;
ย ย ย ย ย ย ย ย camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
ย ย ย ย ย ย ย ย touchX = e.touches[0].pageX; touchY = e.touches[0].pageY;
ย ย ย ย ย ย }
ย ย ย ย });
ย ย </script>
</body>
</html>
