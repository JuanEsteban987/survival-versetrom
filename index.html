<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft JS: ULTIMATE EDITION</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; touch-action: none; }
        canvas { display: block; }
        
        /* Capas de Interfaz */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.85); pointer-events: auto; }
        
        /* Estilo Minecraft */
        .panel { background: #c6c6c6; border: 4px solid #373737; padding: 20px; color: #333; text-align: center; box-shadow: inset -4px -4px #555, inset 4px 4px #fff; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 8px; cursor: pointer; font-weight: bold; border-bottom: 4px solid #2e7d32; text-shadow: 1px 1px #000; width: 220px; }
        .btn:active { border-bottom: 0; transform: translateY(2px); }
        .btn-red { background: #f44336; border-bottom-color: #b71c1c; }
        .btn-blue { background: #2196F3; border-bottom-color: #0b7ad1; }

        /* Inventario y Crafteo */
        .grid { display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; background: #8b8b8b; padding: 10px; border: 3px solid #373737; margin: 10px auto; }
        .slot-ui { width: 60px; height: 60px; background: #8b8b8b; border: 3px solid #373737; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; color: white; position: relative; }
        .slot-ui:hover { border-color: #fff; }
        .slot-count { position: absolute; bottom: 2px; right: 2px; font-size: 10px; background: rgba(0,0,0,0.5); padding: 1px 3px; }

        /* Hotbar */
        #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 6px; border: 3px solid #555; pointer-events: auto; }
        .h-slot { width: 48px; height: 48px; border: 2px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 10px; background: rgba(255,255,255,0.1); }
        .h-slot.active { border-color: #fff; background: rgba(255,255,255,0.3); box-shadow: 0 0 10px #fff; }

        /* Controles Móviles */
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { position: absolute; top: 40px; left: 40px; width: 40px; height: 40px; background: rgba(255,255,255,0.4); border-radius: 50%; }
        .m-btn { position: absolute; width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid rgba(255,255,255,0.1); font-size: 12px; }
        #m-jump { bottom: 40px; right: 110px; width: 100px; height: 60px; }
        #m-mine { bottom: 230px; right: 40px; background: rgba(255, 0, 0, 0.3); }
        #m-place { bottom: 140px; right: 130px; background: rgba(0, 120, 255, 0.3); }
        #m-use { bottom: 140px; right: 40px; background: rgba(255, 235, 59, 0.3); color: black; }
        #m-inv { top: 20px; left: 20px; background: #4CAF50; }
        #m-mod { top: 20px; left: 100px; background: #ff9800; }
        #m-srv { top: 20px; right: 20px; background: #2196F3; }

        #break-progress { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; border: 3px solid white; border-radius: 50%; display: none; opacity: 0.7; }
    </style>
</head>
<body>
    <div id="break-progress"></div>

    <div id="main-menu" class="full-overlay" style="display: flex;">
        <div class="panel">
            <h1>MINECRAFT JS <br><small>ULTIMATE SERVER EDITION</small></h1>
            <button class="btn" onclick="initGame(false)">MODO PC (TECLADO)</button>
            <button class="btn" onclick="initGame(true)">MODO MÓVIL (TOUCH)</button>
        </div>
    </div>

    <div id="srv-panel" class="full-overlay">
        <div class="panel">
            <h2>CREADOR DE SERVIDORES</h2>
            <p id="srv-info">Estado: Desconectado</p>
            <button class="btn btn-blue" onclick="hostServer()">SER EL HOST (SERVIDOR)</button>
            <div id="host-id-area" style="margin: 10px; font-size: 12px; color: #555;"></div>
            <hr>
            <input type="text" id="join-input" placeholder="Pegar ID del Host..." style="padding: 10px; width: 80%; border: 2px solid #373737;"><br>
            <button class="btn" onclick="connectToServer()">UNIRSE A SERVIDOR</button><br>
            <button class="btn btn-red" onclick="closeAllMenus()">VOLVER AL JUEGO</button>
        </div>
    </div>

    <div id="inv-panel" class="full-overlay">
        <div class="panel">
            <h2>CRAFTEO Y MOCHILA</h2>
            <div class="grid" id="craft-slots">
                <div class="slot-ui" onclick="addToCraft(0)">M</div>
                <div class="slot-ui" onclick="addToCraft(1)">P</div>
                <div class="slot-ui" onclick="addToCraft(2)">T</div>
                <div class="slot-ui" onclick="addToCraft(3)">H</div>
            </div>
            <div id="craft-result-btn" class="btn btn-blue" onclick="craftItem()">RESULTADO: NADA</div>
            <button class="btn btn-red" onclick="closeAllMenus()">CERRAR</button>
        </div>
    </div>

    <div id="mod-panel" class="full-overlay">
        <div class="panel">
            <h2>CREADOR DE ÍTEMS CUSTOM</h2>
            <input type="text" id="cust-name" placeholder="Nombre del bloque..."><br>
            <input type="color" id="cust-color" value="#ffffff" style="width: 100px; height: 40px; margin: 10px;"><br>
            <select id="cust-type" style="padding: 10px;">
                <option value="block">Bloque Sólido</option>
                <option value="tool">Herramienta (Pico)</option>
            </select><br>
            <button class="btn" onclick="saveCustomItem()">CREAR Y AGREGAR</button><br>
            <button class="btn btn-red" onclick="closeAllMenus()">CERRAR</button>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">MINAR</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-use">USAR</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-inv">INV</div>
        <div class="m-btn" id="m-mod">MOD</div>
        <div class="m-btn" id="m-srv">SRV</div>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div class="h-slot active" id="hs-0"></div>
            <div class="h-slot" id="hs-1"></div>
            <div class="h-slot" id="hs-2"></div>
            <div class="h-slot" id="hs-3"></div>
            <div class="h-slot" id="hs-4"></div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        // --- CONSTANTES Y ESTADO ---
        let scene, camera, renderer, controls, clock;
        let blocks = [], isMobile = false, activeSlot = 0;
        let velocityY = 0, isGrounded = false, keys = {};
        let isMining = false, mineTime = 0, miningTarget = null;
        let peer, conn, remotePlayers = {};

        const materials = [
            { id: 0, name: "Pasto", color: 0x567d46, count: 64, hardness: 0.5 },
            { id: 1, name: "Tierra", color: 0x8b5a2b, count: 0, hardness: 0.5 },
            { id: 2, name: "Piedra", color: 0x808080, count: 0, hardness: 2.0 },
            { id: 3, name: "Madera", color: 0x654321, count: 0, hardness: 1.0 },
            { id: 4, name: "Hojas", color: 0x228b22, count: 0, hardness: 0.2 },
            { id: 5, name: "Bedrock", color: 0x1a1a1a, count: 0, hardness: Infinity }
        ];

        // --- INICIALIZACIÓN ---
        window.initGame = (mobileMode) => {
            isMobile = mobileMode;
            document.getElementById('main-menu').style.display = 'none';
            if(isMobile) document.getElementById('mobile-controls').style.display = 'block';

            setupThree();
            generateWorld();
            updateHotbarUI();
            animate();
            if(!isMobile) controls.lock();
        };

        function setupThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            controls = new PointerLockControls(camera, document.body);
            clock = new THREE.Clock();

            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.6);
            sun.position.set(10, 20, 10);
            scene.add(sun);
        }

        function createBlock(x, y, z, color, sync = true) {
            const mesh = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1, 1),
                new THREE.MeshStandardMaterial({ color: color })
            );
            mesh.position.set(x, y, z);
            scene.add(mesh);
            blocks.push(mesh);
            
            if(sync && conn && conn.open) {
                conn.send({ type: 'place', x, y, z, color });
            }
        }

        function generateWorld() {
            for(let x = -10; x < 10; x++) {
                for(let z = -10; z < 10; z++) {
                    createBlock(x, 0, z, 0x567d46, false);
                    createBlock(x, -1, z, 0x8b5a2b, false);
                    createBlock(x, -2, z, 0x1a1a1a, false); // Bedrock
                    
                    // Árboles aleatorios
                    if(Math.random() < 0.02) {
                        for(let h=1; h<4; h++) createBlock(x, h, z, 0x654321, false);
                        createBlock(x, 4, z, 0x228b22, false);
                    }
                }
            }
        }

        // --- SISTEMA SERVIDOR (MISMO DISPOSITIVO) ---
        window.hostServer = () => {
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('srv-info').innerText = "ONLINE - Eres el Host";
                document.getElementById('host-id-area').innerText = "ID: " + id;
                console.log("Servidor creado con ID:", id);
            });
            peer.on('connection', (c) => {
                conn = c;
                initConnection();
            });
        };

        window.connectToServer = () => {
            const id = document.getElementById('join-input').value;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                initConnection();
            });
        };

        function initConnection() {
            conn.on('open', () => {
                document.getElementById('srv-info').innerText = "¡CONECTADO!";
                closeAllMenus();
                // Enviar posición cada 50ms
                setInterval(() => {
                    conn.send({ type: 'move', x: camera.position.x, y: camera.position.y, z: camera.position.z });
                }, 50);
            });

            conn.on('data', (data) => {
                if(data.type === 'move') updateRemotePlayer(data);
                if(data.type === 'place') createBlock(data.x, data.y, data.z, data.color, false);
                if(data.type === 'break') removeBlockAt(data.x, data.y, data.z);
            });
        }

        function updateRemotePlayer(data) {
            if(!remotePlayers['peer']) {
                const geo = new THREE.BoxGeometry(0.6, 1.8, 0.6);
                const mat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                remotePlayers['peer'] = new THREE.Mesh(geo, mat);
                scene.add(remotePlayers['peer']);
            }
            remotePlayers['peer'].position.set(data.x, data.y - 0.8, data.z);
        }

        // --- ACCIONES DE JUEGO ---
        function performMining(delta) {
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks);

            if(hits.length > 0 && hits[0].distance < 4.5) {
                const target = hits[0].object;
                if(miningTarget !== target) {
                    miningTarget = target;
                    mineTime = 0;
                }
                
                document.getElementById('break-progress').style.display = 'block';
                mineTime += delta;
                
                // Si el tiempo de minado supera la dureza (simplificado a 1s)
                if(mineTime > 1.0) {
                    removeBlockAt(target.position.x, target.position.y, target.position.z);
                    if(conn) conn.send({ type: 'break', x: target.position.x, y: target.position.y, z: target.position.z });
                    
                    // Recoger bloque
                    const color = target.material.color.getHex();
                    const mat = materials.find(m => m.color === color);
                    if(mat) { mat.count++; updateHotbarUI(); }
                    
                    resetMining();
                }
            } else { resetMining(); }
        }

        function removeBlockAt(x, y, z) {
            const b = blocks.find(v => v.position.x === x && v.position.y === y && v.position.z === z);
            if(b) {
                scene.remove(b);
                blocks = blocks.filter(v => v !== b);
            }
        }

        function resetMining() {
            isMining = false;
            miningTarget = null;
            mineTime = 0;
            document.getElementById('break-progress').style.display = 'none';
        }

        function placeBlock() {
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks);

            if(hits.length > 0 && hits[0].distance < 5) {
                const mat = materials[activeSlot];
                if(mat.count > 0) {
                    const pos = hits[0].object.position.clone().add(hits[0].face.normal);
                    // Evitar poner bloque sobre uno mismo
                    const dist = pos.distanceTo(new THREE.Vector3(camera.position.x, pos.y, camera.position.z));
                    if(dist > 0.8) {
                        createBlock(pos.x, pos.y, pos.z, mat.color);
                        mat.count--;
                        updateHotbarUI();
                    }
                }
            }
        }

        // --- INTERFAZ ---
        function updateHotbarUI() {
            for(let i=0; i<5; i++) {
                const slot = document.getElementById('hs-'+i);
                const mat = materials[i];
                if(mat) {
                    slot.style.background = "#" + mat.color.toString(16).padStart(6, '0');
                    slot.innerHTML = `<div class="slot-count">${mat.count}</div>`;
                }
            }
        }

        window.saveCustomItem = () => {
            const name = document.getElementById('cust-name').value;
            const color = parseInt(document.getElementById('cust-color').value.replace('#', '0x'));
            materials.push({ name, color, count: 10, hardness: 1.0 });
            alert("Bloque '" + name + "' creado!");
            updateHotbarUI();
        };

        window.craftItem = () => {
            if(materials[3].count >= 2) { // 2 de Madera
                materials[3].count -= 2;
                alert("Has crafteado: PICO DE MADERA (Mina x2)");
                // Aquí podrías añadir lógica de herramientas
            } else {
                alert("Faltan materiales: Necesitas 2 de Madera");
            }
        };

        window.closeAllMenus = () => {
            document.querySelectorAll('.full-overlay').forEach(e => e.style.display = 'none');
            if(!isMobile) controls.lock();
        };

        // --- BUCLE DE ANIMACIÓN ---
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);

            if(isMining) performMining(delta);

            if(controls.isLocked || isMobile) {
                // Gravedad
                velocityY -= 25 * delta;
                
                // Movimiento
                const moveVec = new THREE.Vector3();
                if(isMobile) {
                    moveVec.z = -joyDir.y;
                    moveVec.x = joyDir.x;
                } else {
                    if(keys['KeyW']) moveVec.z += 1;
                    if(keys['KeyS']) moveVec.z -= 1;
                    if(keys['KeyA']) moveVec.x -= 1;
                    if(keys['KeyD']) moveVec.x += 1;
                }

                const dir = new THREE.Vector3();
                camera.getWorldDirection(dir);
                dir.y = 0; dir.normalize();
                const right = new THREE.Vector3().crossVectors(dir, camera.up);

                camera.position.addScaledVector(dir, moveVec.z * 6 * delta);
                camera.position.addScaledVector(right, moveVec.x * 6 * delta);
                camera.position.y += velocityY * delta;

                // Suelo simple (Paridad funcional)
                if(camera.position.y < 2.5) {
                    camera.position.y = 2.5;
                    velocityY = 0;
                    isGrounded = true;
                } else {
                    isGrounded = false;
                }
            }

            renderer.render(scene, camera);
        }

        // --- INPUTS ---
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if(e.code === 'Space' && isGrounded) velocityY = 10;
            if(e.code === 'KeyE') { document.getElementById('inv-panel').style.display='flex'; controls.unlock(); }
            if(e.code === 'KeyM') { document.getElementById('mod-panel').style.display='flex'; controls.unlock(); }
            if(e.key >= 1 && e.key <= 5) {
                activeSlot = e.key - 1;
                document.querySelectorAll('.h-slot').forEach((s, i) => s.classList.toggle('active', i === activeSlot));
            }
        });
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        window.addEventListener('mousedown', (e) => {
            if(!controls.isLocked && !isMobile) return;
            if(e.button === 0) isMining = true;
            if(e.button === 2) placeBlock();
        });
        window.addEventListener('mouseup', () => resetMining());

        // Móvil Buttons
        document.getElementById('m-jump').onclick = () => { if(isGrounded) velocityY = 10; };
        document.getElementById('m-mine').ontouchstart = () => isMining = true;
        document.getElementById('m-mine').ontouchend = () => resetMining();
        document.getElementById('m-place').onclick = () => placeBlock();
        document.getElementById('m-inv').onclick = () => { document.getElementById('inv-panel').style.display='flex'; };
        document.getElementById('m-mod').onclick = () => { document.getElementById('mod-panel').style.display='flex'; };
        document.getElementById('m-srv').onclick = () => { document.getElementById('srv-panel').style.display='flex'; };

        // Joystick Móvil
        let joyDir = {x:0, y:0}, touchStartX, touchStartY;
        document.getElementById('joystick-zone').ontouchmove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const touch = e.touches[0];
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            const x = touch.clientX - centerX;
            const y = touch.clientY - centerY;
            const dist = Math.min(Math.sqrt(x*x + y*y), 40);
            const angle = Math.atan2(y, x);
            
            joyDir.x = (Math.cos(angle) * dist) / 40;
            joyDir.y = (Math.sin(angle) * dist) / 40;
            
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        };
        document.getElementById('joystick-zone').ontouchend = () => {
            joyDir = {x:0, y:0};
            document.getElementById('joystick-knob').style.transform = `translate(0,0)`;
        };

        // Rotación Cámara Táctil
        window.addEventListener('touchstart', (e) => {
            if(isMobile && e.touches[0].pageX > window.innerWidth/2) {
                touchStartX = e.touches[0].pageX;
                touchStartY = e.touches[0].pageY;
            }
        });
        window.addEventListener('touchmove', (e) => {
            if(isMobile && e.touches[0].pageX > window.innerWidth/2) {
                const touch = e.touches[0];
                const dx = touch.pageX - touchStartX;
                const dy = touch.pageY - touchStartY;
                camera.rotation.y -= dx * 0.005;
                camera.rotation.x -= dy * 0.005;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                touchStartX = touch.pageX;
                touchStartY = touch.pageY;
            }
        });

    </script>
</body>
</html>
