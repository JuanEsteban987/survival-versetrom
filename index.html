<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: Paridad Total & Crafteo</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #87ceeb; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.9); pointer-events: auto; }
        
        /* Botones y UI */
        .btn { background: #4CAF50; color: white; border: none; padding: 12px; margin: 5px; cursor: pointer; width: 220px; font-weight: bold; border-bottom: 4px solid #2e7d32; }
        .btn-red { background: #f44336; border-bottom-color: #b71c1c; }
        .btn-blue { background: #2196F3; border-bottom-color: #0b7ad1; }
        
        /* Paneles */
        #inventory-panel, #obj-editor { background: #c6c6c6; border: 4px solid #373737; padding: 15px; color: #333; display: none; flex-direction: column; align-items: center; z-index: 110; }
        .crafting-grid { display: grid; grid-template-columns: repeat(2, 60px); gap: 10px; background: #8b8b8b; padding: 10px; border: 3px solid #373737; }
        .craft-slot { width: 60px; height: 60px; background: #8b8b8b; border: 3px solid #373737; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: white; text-align: center; }

        /* Controles Móvil */
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        .m-btn { position: absolute; width: 60px; height: 60px; background: rgba(255,255,255,0.3); border-radius: 10px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; }
        
        #m-mine { bottom: 220px; right: 30px; background: rgba(255,0,0,0.4); }
        #m-place { bottom: 140px; right: 100px; background: rgba(0,120,255,0.4); }
        #m-use { bottom: 140px; right: 20px; background: rgba(255,235,59,0.5); color: black; }
        #m-jump { bottom: 40px; right: 60px; width: 100px; }
        #m-inv { top: 10px; left: 10px; background: #4CAF50; }
        #m-mod { top: 10px; left: 80px; background: #ff9800; }
        #m-srv { top: 10px; right: 10px; background: #2196F3; }

        /* Hotbar */
        #hotbar { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; }
        .slot.active { border-color: white; background: rgba(255,255,255,0.2); }
        #break-indicator { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>
    <div id="break-indicator"></div>

    <div id="menu" class="full-overlay" style="display: flex;">
        <h1>MINECRAFT JS: PARIDAD</h1>
        <button class="btn" onclick="startGame(false)">MODO PC</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
    </div>

    <div id="inventory-panel" class="full-overlay">
        <h2 style="color: #333">CRAFTEO</h2>
        <div class="crafting-grid" id="craft-grid">
            <div class="craft-slot" onclick="selectCraft(0)"></div>
            <div class="craft-slot" onclick="selectCraft(1)"></div>
            <div class="craft-slot" onclick="selectCraft(2)"></div>
            <div class="craft-slot" onclick="selectCraft(3)"></div>
        </div>
        <button class="btn" onclick="doCraft()">CRAFTEAR ITEM</button>
        <button class="btn btn-red" onclick="closeAll()">CERRAR</button>
    </div>

    <div id="srv-menu" class="full-overlay">
        <h2>HOSTING P2P</h2>
        <p id="srv-status">Estado: Offline</p>
        <button class="btn btn-blue" onclick="startHost()">HOSTEAR MUNDO</button>
        <p id="my-id-display" style="font-size: 10px;"></p>
        <input type="text" id="join-id" placeholder="ID del Host..." style="padding:10px; margin:5px;">
        <button class="btn" onclick="joinServer()">UNIRSE A AMIGO</button>
        <button class="btn btn-red" onclick="closeAll()">CERRAR</button>
    </div>

    <div id="obj-editor" class="full-overlay">
        <h2 style="color: #333">CREADOR</h2>
        <input type="text" id="obj-name" placeholder="Nombre...">
        <select id="obj-type"><option value="block">Bloque</option><option value="tool">Pico</option></select>
        <input type="color" id="obj-color" value="#ffffff">
        <button class="btn" onclick="saveCustom()">GUARDAR OBJETO</button>
        <button class="btn btn-red" onclick="closeAll()">CANCELAR</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">MINAR</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-use">USAR</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-inv">INV</div>
        <div class="m-btn" id="m-mod">Crea</div>
        <div class="m-btn" id="m-srv">SRV</div>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div class="slot active" id="sl0"></div>
            <div class="slot" id="sl1"></div>
            <div class="slot" id="sl2"></div>
            <div class="slot" id="sl3"></div>
            <div class="slot" id="sl4"></div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        // --- CONSTANTES Y MUNDO ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 0.5); sun.position.set(5, 15, 5); scene.add(sun);

        let blocks = [], isMobile = false, activeSlot = 0;
        let keys = {}, velocityY = 0, isGrounded = false;
        let isMining = false, mineProgress = 0;
        let peer, conn, remotePlayer;

        const catalog = [
            { name: "Pasto", color: 0x2e7d32, count: 64 },
            { name: "Tierra", color: 0x795548, count: 0 },
            { name: "Piedra", color: 0x9e9e9e, count: 0 },
            { name: "Madera", color: 0x5d4037, count: 0 },
            { name: "Bedrock", color: 0x1a1a1a, count: 0 }
        ];

        // --- FUNCIONES ---
        function addBlock(x, y, z, color, sync = true) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color }));
            mesh.position.set(x, y, z);
            scene.add(mesh); blocks.push(mesh);
            if(sync && conn && conn.open) conn.send({ type: 'place', x, y, z, color });
        }

        function generateWorld() {
            for(let x=-8; x<8; x++) {
                for(let z=-8; z<8; z++) {
                    addBlock(x, 0, z, 0x2e7d32, false);
                    addBlock(x, -1, z, 0x795548, false);
                    addBlock(x, -2, z, 0x1a1a1a, false);
                }
            }
        }

        window.startGame = (m) => {
            isMobile = m; document.getElementById('menu').style.display = 'none';
            if(m) document.getElementById('mobile-controls').style.display = 'block';
            else controls.lock();
            generateWorld(); camera.position.set(0, 4, 0); animate(); updateHotbar();
        };

        window.closeAll = () => {
            document.querySelectorAll('.full-overlay').forEach(e => e.style.display='none');
            if(!isMobile) controls.lock();
        };

        // --- SISTEMA DE INVENTARIO Y CRAFTEO ---
        function updateHotbar() {
            for(let i=0; i<5; i++) {
                const s = document.getElementById('sl'+i);
                s.style.background = catalog[i].count > 0 ? "#"+catalog[i].color.toString(16) : "#444";
                s.innerText = catalog[i].count > 0 ? catalog[i].count : "";
            }
        }

        window.doCraft = () => {
            // Ejemplo: 2 de Madera = 1 Pico (Simplificado para paridad)
            if(catalog[3].count >= 2) {
                catalog[3].count -= 2;
                alert("¡Crafteaste una Herramienta!");
                updateHotbar();
            } else { alert("Faltan materiales (Necesitas Madera)"); }
        };

        // --- MULTIPLAYER ---
        window.startHost = () => {
            peer = new Peer();
            peer.on('open', id => { 
                document.getElementById('srv-status').innerText = "Hosting..."; 
                document.getElementById('my-id-display').innerText = id; 
            });
            peer.on('connection', c => { conn = c; setupConn(); });
        };

        window.joinServer = () => {
            conn = new Peer().connect(document.getElementById('join-id').value);
            setupConn();
        };

        function setupConn() {
            conn.on('open', () => { document.getElementById('srv-status').innerText = "Conectado!"; closeAll(); });
            conn.on('data', data => {
                if(data.type === 'place') addBlock(data.x, data.y, data.z, data.color, false);
                if(data.type === 'move') {
                    if(!remotePlayer) {
                        remotePlayer = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.7, 0.5), new THREE.MeshBasicMaterial({color: 0xff0000}));
                        scene.add(remotePlayer);
                    }
                    remotePlayer.position.set(data.x, data.y - 0.8, data.z);
                }
            });
        }

        // --- LOOP Y FÍSICA ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);

            // Gravedad corregida
            velocityY -= 25 * delta;
            
            const move = new THREE.Vector3();
            if(isMobile) { move.z = -joyDir.y; move.x = joyDir.x; }
            else {
                if(keys['KeyW']) move.z += 1; if(keys['KeyS']) move.z -= 1;
                if(keys['KeyA']) move.x -= 1; if(keys['KeyD']) move.x += 1;
            }

            const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
            const right = new THREE.Vector3().crossVectors(dir, camera.up);

            camera.position.addScaledVector(dir, move.z * 6 * delta);
            camera.position.addScaledVector(right, move.x * 6 * delta);
            camera.position.y += velocityY * delta;

            if(camera.position.y < 2.5) { camera.position.y = 2.5; velocityY = 0; isGrounded = true; }
            else isGrounded = false;

            if(conn && conn.open) conn.send({type:'move', x: camera.position.x, y: camera.position.y, z: camera.position.z});
            renderer.render(scene, camera);
        }

        // --- INPUTS (PC & MÓVIL) ---
        window.addEventListener('keydown', e => { 
            keys[e.code] = true;
            if(e.code === 'Space' && isGrounded) velocityY = 10;
            if(e.key === 'e' || e.key === 'E') { document.getElementById('inventory-panel').style.display='flex'; controls.unlock(); }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        document.getElementById('m-jump').onclick = () => { if(isGrounded) velocityY = 10; };
        document.getElementById('m-inv').onclick = () => { document.getElementById('inventory-panel').style.display='flex'; };
        document.getElementById('m-srv').onclick = () => { document.getElementById('srv-menu').style.display='flex'; };
        document.getElementById('m-mod').onclick = () => { document.getElementById('obj-editor').style.display='flex'; };

        // Acción Poner Bloque
        function placeBlock() {
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks);
            if(hits.length > 0 && hits[0].distance < 5) {
                const item = catalog[activeSlot];
                if(item.count > 0) {
                    const p = hits[0].object.position.clone().add(hits[0].face.normal);
                    addBlock(p.x, p.y, p.z, item.color);
                    item.count--; updateHotbar();
                }
            }
        }

        window.addEventListener('mousedown', e => { if(e.button === 2) placeBlock(); });
        document.getElementById('m-place').onclick = placeBlock;

        // Joystick Móvil
        let joyDir = {x:0, y:0}, touchX, touchY;
        document.getElementById('joystick-container').ontouchmove = e => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
            const dist = Math.min(Math.sqrt(x*x + y*y), 45), angle = Math.atan2(y, x);
            joyDir = { x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45 };
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        };
        document.getElementById('joystick-container').ontouchend = () => { joyDir = {x:0,y:0}; document.getElementById('joystick-knob').style.transform = 'translate(0,0)'; };

        window.addEventListener('touchstart', e => { if(isMobile && e.touches[0].pageX > window.innerWidth/2) { touchX = e.touches[0].pageX; touchY = e.touches[0].pageY; }});
        window.addEventListener('touchmove', e => {
            if(isMobile && e.touches[0].pageX > window.innerWidth/2) {
                camera.rotation.y -= (e.touches[0].pageX - touchX) * 0.005;
                camera.rotation.x -= (e.touches[0].pageY - touchY) * 0.005;
                touchX = e.touches[0].pageX; touchY = e.touches[0].pageY;
            }
        });
    </script>
</body>
</html>
