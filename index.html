<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Madness Combat: Arena Waves</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: #eee; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        canvas { background: #333; border: 5px solid #555; cursor: crosshair; }
        .hud { width: 900; display: flex; justify-content: space-between; padding: 10px; background: #222; border: 2px solid #444; width: 880px; }
        .shop { position: absolute; top: 20%; background: rgba(0,0,0,0.9); padding: 20px; border: 2px solid #800; display: none; text-align: center; }
        .red { color: #ff4444; }
        .gold { color: #ffd700; }
    </style>
</head>
<body>
    <div class="hud">
        <div>HP: <span id="hp" class="red">100</span> | PUNTOS: $<span id="money" class="gold">0</span></div>
        <div>OLEADA: <span id="wave">1</span> | ARMA: <span id="weaponName">PUÑOS</span></div>
    </div>
    
    <div id="shopUI" class="shop">
        <h2 class="red">TIENDA DE NEVADA</h2>
        <p>Presiona el número para comprar:</p>
        <p>[1] CUCHILLO - $50</p>
        <p>[2] PISTOLA - $150</p>
        <p>[3] ESCOPETA - $400</p>
        <p>--- Presiona <b>ESPACIO</b> para iniciar siguiente oleada ---</p>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 900; canvas.height = 600;

// Configuración del Jugador y Armas
let player = { x: 450, y: 300, hp: 100, money: 0, angle: 0, speed: 4 };
let weapons = {
    "punos": { name: "PUÑOS", range: 40, damage: 10, type: "melee", price: 0 },
    "cuchillo": { name: "CUCHILLO", range: 60, damage: 25, type: "melee", price: 50 },
    "pistola": { name: "PISTOLA", range: 1000, damage: 20, type: "ranged", price: 150 },
    "escopeta": { name: "ESCOPETA", range: 1000, damage: 15, type: "ranged", price: 400 }
};
let currentWep = weapons.punos;

// Estado del Juego
let enemies = []; let bullets = []; let particles = [];
let wave = 1; let enemiesLeftInWave = 0;
let inShop = false;
let keys = {};

// Controles
window.addEventListener("keydown", e => {
    keys[e.code] = true;
    if(e.code === 'Space' && inShop) startWave();
    if(inShop) {
        if(e.key === '1' && player.money >= 50) { player.money -= 50; currentWep = weapons.cuchillo; }
        if(e.key === '2' && player.money >= 150) { player.money -= 150; currentWep = weapons.pistola; }
        if(e.key === '3' && player.money >= 400) { player.money -= 400; currentWep = weapons.escopeta; }
        updateHUD();
    }
});
window.addEventListener("keyup", e => keys[e.code] = false);
window.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    player.angle = Math.atan2(e.clientY - rect.top - player.y, e.clientX - rect.left - player.x);
});
window.addEventListener("mousedown", () => { if(!inShop) attack(); });

function updateHUD() {
    document.getElementById("hp").innerText = Math.floor(player.hp);
    document.getElementById("money").innerText = player.money;
    document.getElementById("wave").innerText = wave;
    document.getElementById("weaponName").innerText = currentWep.name;
}

function attack() {
    if(currentWep.type === "ranged") {
        let count = currentWep.name === "ESCOPETA" ? 5 : 1;
        for(let i=0; i<count; i++) {
            bullets.push({
                x: player.x, y: player.y,
                vx: Math.cos(player.angle + (Math.random()-0.5)*0.2) * 15,
                vy: Math.sin(player.angle + (Math.random()-0.5)*0.2) * 15
            });
        }
    } else {
        // Ataque Melee
        enemies.forEach(en => {
            let d = Math.hypot(en.x - player.x, en.y - player.y);
            if(d < currentWep.range) {
                en.hp -= currentWep.damage;
                createBlood(en.x, en.y);
            }
        });
    }
}

function createBlood(x, y) {
    for(let i=0; i<5; i++) particles.push({x, y, vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8, life: 15});
}

function startWave() {
    inShop = false;
    document.getElementById("shopUI").style.display = "none";
    enemiesLeftInWave = 3 + (wave * 2);
    for(let i=0; i<enemiesLeftInWave; i++) {
        setTimeout(spawnEnemy, i * 1000);
    }
}

function spawnEnemy() {
    enemies.push({ x: Math.random()*canvas.width, y: Math.random() < 0.5 ? 0 : canvas.height, hp: 30 + (wave*5) });
}

function update() {
    if(inShop) return;

    if (keys['KeyW']) player.y -= player.speed;
    if (keys['KeyS']) player.y += player.speed;
    if (keys['KeyA']) player.x -= player.speed;
    if (keys['KeyD']) player.x += player.speed;

    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        enemies.forEach((en, ei) => {
            if(Math.hypot(b.x-en.x, b.y-en.y) < 20) {
                en.hp -= currentWep.damage;
                createBlood(en.x, en.y);
                bullets.splice(i, 1);
            }
        });
    });

    enemies.forEach((en, i) => {
        let dx = player.x - en.x, dy = player.y - en.y;
        let dist = Math.hypot(dx, dy);
        en.x += (dx/dist) * 2; en.y += (dy/dist) * 2;

        if(dist < 30) player.hp -= 0.2;

        if(en.hp <= 0) {
            enemies.splice(i, 1);
            player.money += 20;
            updateHUD();
        }
    });

    if(enemies.length === 0 && enemiesLeftInWave <= 0 && !inShop) {
        inShop = true;
        wave++;
        document.getElementById("shopUI").style.display = "block";
    }

    if(player.hp <= 0) { alert("GAME OVER"); location.reload(); }

    draw();
    requestAnimationFrame(update);
}

function drawAgent(x, y, ang, color) {
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = "black"; ctx.stroke();
    // Cara
    ctx.rotate(ang);
    ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(10,0); ctx.moveTo(0,-10); ctx.lineTo(0,10); ctx.stroke();
    // Manos
    ctx.fillStyle = "#666";
    ctx.beginPath(); ctx.arc(25, 15, 6, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(25, -15, 6, 0, Math.PI*2); ctx.fill();
    ctx.restore();
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // Sangre
    ctx.fillStyle = "red";
    particles.forEach((p, i) => {
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    });
    // Balas
    ctx.fillStyle = "yellow";
    bullets.forEach(b => ctx.fillRect(b.x, b.y, 5, 5));
    // Personajes
    enemies.forEach(en => drawAgent(en.x, en.y, Math.atan2(player.y-en.y, player.x-en.x), "#555"));
    drawAgent(player.x, player.y, player.angle, "#999");
}

updateHUD();
startWave();
</script>
</body>
</html>
