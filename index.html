<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: P2P Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.85); pointer-events: auto; }
        #m-hub { background: rgba(0,0,0,0.95); }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 8px; cursor: pointer; border-radius: 4px; width: 260px; font-weight: bold; border-bottom: 4px solid #2e7d32; }
        .btn:active { border-bottom: 0; transform: translateY(2px); }
        .btn-red { background: #f44336; border-bottom-color: #b71c1c; }
        .btn-blue { background: #2196F3; border-bottom-color: #0b7ad1; }
        .mod-row { margin: 8px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; width: 300px; justify-content: space-between; font-size: 13px; }
        #server-panel { background: rgba(30,30,30,0.95); border: 2px solid #2196F3; padding: 20px; border-radius: 10px; text-align: center; }
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        .m-btn { position: absolute; width: 65px; height: 65px; background: rgba(255,255,255,0.2); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid rgba(255,255,255,0.1); }
        #m-mine { bottom: 210px; right: 40px; background: rgba(255, 0, 0, 0.3); }
        #m-use { bottom: 130px; right: 40px; background: rgba(255, 235, 59, 0.3); color: black; }
        #m-place { bottom: 130px; right: 130px; background: rgba(0, 120, 255, 0.3); }
        #m-jump { bottom: 40px; right: 85px; width: 100px; height: 55px; background: rgba(255,255,255,0.3); }
        #m-inv { top: 15px; left: 15px; width: 50px; height: 50px; background: #4CAF50; }
        #m-mod { top: 15px; left: 75px; width: 50px; height: 50px; background: #ff9800; }
        #m-srv { top: 80px; right: 15px; width: 50px; height: 50px; background: #2196F3; }
        #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.7); padding: 5px; border: 3px solid #555; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; background: rgba(255,255,255,0.1); cursor: pointer; }
        .slot.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
        #break-indicator { position: absolute; top: 50%; left: 50%; width: 22px; height: 22px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
    </style>
</head>
<body>
    <div id="break-indicator"></div>
    
    <div id="menu" class="full-overlay" style="display: flex;">
        <h1>MINECRAFT JS: MULTIPLAYER</h1>
        <button class="btn" onclick="startGame(false)">MODO PC</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
    </div>

    <div id="srv-menu" class="full-overlay">
        <div id="server-panel">
            <h2>CREADOR DE SERVIDOR</h2>
            <p id="srv-status">Estado: Desconectado</p>
            <div id="host-section">
                <button class="btn btn-blue" onclick="startHost()">HOSTEAR (Ser Servidor)</button>
                <p id="my-id-display"></p>
            </div>
            <hr style="border:1px solid #444; width:100%">
            <div id="client-section">
                <input type="text" id="join-id" placeholder="ID del Host..." style="padding:10px; width:240px; border-radius:5px; border:none; margin-bottom:10px;"><br>
                <button class="btn" onclick="joinServer()">UNIRSE A SERVIDOR</button>
            </div>
            <button class="btn btn-red" onclick="closeAllMenus()">VOLVER</button>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">MINAR</div>
        <div class="m-btn" id="m-use">USAR</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-inv">INV</div>
        <div class="m-btn" id="m-mod">M</div>
        <div class="m-btn" id="m-srv">SRV</div>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div class="slot active" data-color="null" data-count="0" onclick="updateActiveSlot(0)">1</div>
            <div class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(1)">2</div>
            <div class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(2)">3</div>
            <div class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(3)">4</div>
            <div class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(4)">5</div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        let blocks = [], isMobile = false, activeSlot = 0, keys = {};
        let velocityY = 0, isGrounded = false, isMining = false, mineProgress = 0, currentTarget = null;
        const catalog = [{color:0x2e7d32},{color:0x795548},{color:0x9e9e9e},{color:0x5d4037},{color:0x388e3c},{color:0x1a1a1a},{color:0x8b4513}];

        // Red Multiplayer
        let peer, conn, players = {};
        const playerGeo = new THREE.BoxGeometry(0.6, 1.8, 0.6);
        const playerMat = new THREE.MeshStandardMaterial({color: 0xff0000});

        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(80, window.innerWidth/window.innerHeight, 0.1, 500);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new PointerLockControls(camera, document.body);

        function addBlock(x, y, z, color, sync = true) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color }));
            m.position.set(x, y, z);
            m.matrixAutoUpdate = false; m.updateMatrix();
            scene.add(m); blocks.push(m);
            if(sync && conn && conn.open) {
                conn.send({ type: 'place', x, y, z, color });
            }
            return m;
        }

        // Lógica de Servidor
        window.startHost = () => {
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('srv-status').innerText = "Hosting... ID generado";
                document.getElementById('my-id-display').innerText = "Tu ID: " + id;
                console.log("ID de servidor:", id);
            });
            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                document.getElementById('srv-status').innerText = "Cliente Conectado!";
            });
        };

        window.joinServer = () => {
            const id = document.getElementById('join-id').value;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                setupConnection();
                document.getElementById('srv-status').innerText = "Conectando al Host...";
            });
        };

        function setupConnection() {
            conn.on('open', () => {
                document.getElementById('srv-status').innerText = "Sincronizado!";
                setInterval(() => {
                    conn.send({ type: 'move', x: camera.position.x, y: camera.position.y, z: camera.position.z });
                }, 50);
            });
            conn.on('data', (data) => {
                if(data.type === 'place') addBlock(data.x, data.y, data.z, data.color, false);
                if(data.type === 'move') updateRemotePlayer(data);
                if(data.type === 'break') removeBlockAt(data.x, data.y, data.z);
            });
        }

        function updateRemotePlayer(data) {
            if(!players['remote']) {
                players['remote'] = new THREE.Mesh(playerGeo, playerMat);
                scene.add(players['remote']);
            }
            players['remote'].position.set(data.x, data.y - 0.8, data.z);
        }

        function removeBlockAt(x, y, z) {
            const b = blocks.find(b => b.position.x === x && b.position.y === y && b.position.z === z);
            if(b) { scene.remove(b); blocks = blocks.filter(v => v !== b); }
        }

        // Generación Simple
        function generateWorld() {
            for(let x=-8; x<8; x++) {
                for(let z=-8; z<8; z++) {
                    addBlock(x, 0, z, 0x2e7d32, false);
                    addBlock(x, -1, z, 0x795548, false);
                }
            }
        }

        window.handlePlace = () => {
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks, false);
            if(hits.length > 0 && hits[0].distance < 5) {
                const s = document.querySelectorAll('.slot')[activeSlot];
                if(s.dataset.color !== "null") {
                    const pos = hits[0].object.position.clone().add(hits[0].face.normal);
                    const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(camera.position.x, camera.position.y-0.9, camera.position.z), new THREE.Vector3(0.6, 1.8, 0.6));
                    if(!pBox.intersectsBox(new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(0.9,0.9,0.9)))) {
                        addBlock(pos.x, pos.y, pos.z, parseInt(s.dataset.color));
                    }
                }
            }
        };

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);
            
            if(isMining) {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects(blocks, false);
                if(hits.length > 0 && hits[0].distance < 4.5) {
                    const b = hits[0].object;
                    mineProgress += delta * 2;
                    document.getElementById('break-indicator').style.display = 'block';
                    if(mineProgress >= 1) {
                        if(conn) conn.send({type: 'break', x: b.position.x, y: b.position.y, z: b.position.z});
                        scene.remove(b); blocks = blocks.filter(x => x !== b);
                        mineProgress = 0; isMining = false;
                    }
                }
            }

            if((controls.isLocked || isMobile)) {
                velocityY -= 28 * delta;
                const moveVec = new THREE.Vector3();
                if(isMobile) { moveVec.z = -joyDir.y; moveVec.x = joyDir.x; }
                else { if(keys['KeyW']) moveVec.z += 1; if(keys['KeyS']) moveVec.z -= 1; if(keys['KeyA']) moveVec.x -= 1; if(keys['KeyD']) moveVec.x += 1; }
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
                const right = new THREE.Vector3().crossVectors(dir, camera.up).normalize();
                camera.position.addScaledVector(dir, moveVec.z * 6 * delta).addScaledVector(right, moveVec.x * 6 * delta);
                camera.position.y += velocityY * delta;
                if(camera.position.y < 3) { camera.position.y = 3; velocityY = 0; isGrounded = true; } else isGrounded = false;
            }
            renderer.render(scene, camera);
        }

        window.startGame = (m) => { 
            isMobile = m; document.getElementById('menu').style.display='none'; 
            if(m) document.getElementById('mobile-controls').style.display='block'; 
            generateWorld(); animate(); 
            // Slots iniciales
            catalog.forEach((item, i) => { if(i<5) {
                const s = document.querySelectorAll('.slot')[i];
                s.dataset.color = item.color; s.style.backgroundColor = "#"+item.color.toString(16);
            }});
        };

        window.closeAllMenus = () => { document.querySelectorAll('.full-overlay').forEach(el => el.style.display = 'none'); if(!isMobile) controls.lock(); };
        window.updateActiveSlot = (i) => { activeSlot = i; document.querySelectorAll('.slot').forEach((s,idx) => s.classList.toggle('active', idx === i)); };

        // Eventos
        window.addEventListener('mousedown', e => { if(e.button===0) isMining=true; if(e.button===2) handlePlace(); });
        window.addEventListener('mouseup', () => { isMining=false; document.getElementById('break-indicator').style.display='none'; });
        window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space' && isGrounded) velocityY=10; });
        window.addEventListener('keyup', e => keys[e.code] = false);

        document.getElementById('m-srv').onclick = () => { document.getElementById('srv-menu').style.display='flex'; controls.unlock(); };
        document.getElementById('m-mine').ontouchstart = () => isMining = true;
        document.getElementById('m-mine').ontouchend = () => { isMining=false; document.getElementById('break-indicator').style.display='none'; };
        document.getElementById('m-place').onclick = handlePlace;
        document.getElementById('m-jump').onclick = () => { if(isGrounded) velocityY=10; };

        let joyDir = {x:0,y:0}, touchX, touchY;
        document.getElementById('joystick-container').addEventListener('touchmove', e => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
            const dist = Math.min(Math.sqrt(x*x + y*y), 45), angle = Math.atan2(y, x);
            joyDir = { x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45 };
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        });
        document.getElementById('joystick-container').addEventListener('touchend', () => { joyDir = {x:0,y:0}; document.getElementById('joystick-knob').style.transform = 'translate(0,0)'; });
        window.addEventListener('touchstart', e => { if(isMobile && e.touches[0].pageX > window.innerWidth/2) { touchX = e.touches[0].pageX; touchY = e.touches[0].pageY; }});
        window.addEventListener('touchmove', e => {
            if(isMobile && e.touches[0].pageX > window.innerWidth/2) {
                camera.rotation.y -= (e.touches[0].pageX - touchX) * 0.005;
                camera.rotation.x -= (e.touches[0].pageY - touchY) * 0.005;
                touchX = e.touches[0].pageX; touchY = e.touches[0].pageY;
            }
        });
    </script>
</body>
</html>
