<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: Fixed Movement & Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #87ceeb; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.85); pointer-events: auto; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 8px; cursor: pointer; border-radius: 4px; width: 260px; font-weight: bold; border-bottom: 4px solid #2e7d32; }
        .btn-blue { background: #2196F3; border-bottom-color: #0b7ad1; }
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        .m-btn { position: absolute; width: 65px; height: 65px; background: rgba(255,255,255,0.3); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        #m-mine { bottom: 210px; right: 40px; background: rgba(255, 0, 0, 0.4); }
        #m-place { bottom: 130px; right: 130px; background: rgba(0, 120, 255, 0.4); }
        #m-jump { bottom: 40px; right: 85px; width: 100px; height: 55px; background: rgba(255,255,255,0.4); }
        #m-srv { top: 15px; right: 15px; width: 50px; height: 50px; background: #2196F3; }
        #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.7); padding: 5px; border: 3px solid #555; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
        .slot.active { border-color: #fff; background: rgba(255,255,255,0.3); }
        #break-indicator { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>
    <div id="break-indicator"></div>
    <div id="menu" class="full-overlay" style="display: flex;">
        <h1>MINECRAFT JS: FIXED</h1>
        <button class="btn" onclick="startGame(false)">MODO PC</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
    </div>

    <div id="srv-menu" class="full-overlay">
        <div style="background:#222; padding:20px; border-radius:10px; text-align:center;">
            <h2>SERVER P2P</h2>
            <p id="srv-status">Estado: Offline</p>
            <button class="btn btn-blue" onclick="startHost()">HOSTEAR</button>
            <p id="my-id-display" style="font-size:10px;"></p>
            <input type="text" id="join-id" placeholder="ID del Host..." style="padding:10px; margin:10px; width:80%;">
            <button class="btn" onclick="joinServer()">UNIRSE</button>
            <button class="btn" onclick="closeSrv()">CERRAR</button>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">MINAR</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-srv">SRV</div>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div class="slot active" id="sl0">1</div>
            <div class="slot" id="sl1">2</div>
            <div class="slot" id="sl2">3</div>
            <div class="slot" id="sl3">4</div>
            <div class="slot" id="sl4">5</div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const sun = new THREE.DirectionalLight(0xffffff, 0.6);
        sun.position.set(10, 20, 10);
        scene.add(sun);

        // --- VARIABLES ---
        let blocks = [], isMobile = false, activeSlot = 0;
        let keys = {}, velocity = new THREE.Vector3();
        let isGrounded = false, isMining = false, mineProgress = 0;
        let peer, conn, remotePlayer;

        const inventory = [
            { name: "Pasto", color: 0x2e7d32, power: 1 },
            { name: "Tierra", color: 0x795548, power: 1 },
            { name: "Piedra", color: 0x9e9e9e, power: 1 },
            { name: "Madera", color: 0x5d4037, power: 1 },
            { name: "Pico", color: 0xffd700, type: "tool", power: 5 }
        ];

        // --- LÓGICA DE BLOQUES ---
        function addBlock(x, y, z, color, sync = true) {
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            scene.add(mesh);
            blocks.push(mesh);
            if(sync && conn && conn.open) conn.send({ type: 'place', x, y, z, color });
            return mesh;
        }

        function generateWorld() {
            for(let x = -10; x < 10; x++) {
                for(let z = -10; z < 10; z++) {
                    const h = Math.floor(Math.random() * 2);
                    addBlock(x, h, z, 0x2e7d32, false);
                    addBlock(x, h-1, z, 0x795548, false);
                    addBlock(x, h-2, z, 0x1a1a1a, false); // Bedrock
                }
            }
        }

        // --- MOVIMIENTO CORREGIDO ---
        function updateMovement(delta) {
            if (!controls.isLocked && !isMobile) return;

            // Gravedad
            velocity.y -= 25 * delta;

            const moveDir = new THREE.Vector3();
            if (isMobile) {
                moveDir.z = -joyDir.y;
                moveDir.x = joyDir.x;
            } else {
                if (keys['KeyW']) moveDir.z += 1;
                if (keys['KeyS']) moveDir.z -= 1;
                if (keys['KeyA']) moveDir.x -= 1;
                if (keys['KeyD']) moveDir.x += 1;
            }

            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            dir.y = 0; dir.normalize();
            const right = new THREE.Vector3().crossVectors(dir, camera.up);

            const speed = 6;
            const nextPos = camera.position.clone();
            nextPos.addScaledVector(dir, moveDir.z * speed * delta);
            nextPos.addScaledVector(right, moveDir.x * speed * delta);
            
            // Colisión simple (No atravesar suelo)
            if (nextPos.y < 2.5) {
                nextPos.y = 2.5;
                velocity.y = 0;
                isGrounded = true;
            } else {
                isGrounded = false;
            }
            
            camera.position.copy(nextPos);
            camera.position.y += velocity.y * delta;

            if (conn && conn.open) {
                conn.send({ type: 'move', x: camera.position.x, y: camera.position.y, z: camera.position.z });
            }
        }

        // --- MULTIPLAYER ---
        window.startHost = () => {
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('srv-status').innerText = "Hosting...";
                document.getElementById('my-id-display').innerText = id;
            });
            peer.on('connection', c => { conn = c; setupConn(); });
        };

        window.joinServer = () => {
            const id = document.getElementById('join-id').value;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                setupConn();
            });
        };

        function setupConn() {
            conn.on('open', () => {
                document.getElementById('srv-status').innerText = "Conectado!";
                closeSrv();
            });
            conn.on('data', data => {
                if(data.type === 'place') addBlock(data.x, data.y, data.z, data.color, false);
                if(data.type === 'move') {
                    if(!remotePlayer) {
                        remotePlayer = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.8, 0.6), new THREE.MeshBasicMaterial({color: 0xff0000}));
                        scene.add(remotePlayer);
                    }
                    remotePlayer.position.set(data.x, data.y - 0.8, data.z);
                }
            });
        }

        // --- GAME LOOP ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);
            updateMovement(delta);
            renderer.render(scene, camera);
        }

        // --- UI & INPUT ---
        window.startGame = (m) => {
            isMobile = m;
            document.getElementById('menu').style.display = 'none';
            if(m) document.getElementById('mobile-controls').style.display = 'block';
            else controls.lock();
            generateWorld();
            camera.position.set(0, 5, 0);
            animate();
            updateSlots();
        };

        function updateSlots() {
            inventory.forEach((item, i) => {
                const s = document.getElementById('sl'+i);
                if(s) {
                    s.style.background = "#" + item.color.toString(16).padStart(6, '0');
                    s.innerText = item.type === "tool" ? "⛏️" : i+1;
                }
            });
        }

        window.closeSrv = () => { document.getElementById('srv-menu').style.display = 'none'; if(!isMobile) controls.lock(); };
        document.getElementById('m-srv').onclick = () => { document.getElementById('srv-menu').style.display = 'flex'; controls.unlock(); };
        document.getElementById('m-jump').onclick = () => { if(isGrounded) velocity.y = 10; };
        
        window.addEventListener('keydown', e => { 
            keys[e.code] = true; 
            if(e.code === 'Space' && isGrounded) velocity.y = 10;
            if(e.key >= 1 && e.key <= 5) {
                activeSlot = e.key - 1;
                document.querySelectorAll('.slot').forEach((s, i) => s.classList.toggle('active', i === activeSlot));
            }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Joystick
        let joyDir = {x:0, y:0}, touchX, touchY;
        document.getElementById('joystick-container').ontouchmove = e => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
            const dist = Math.min(Math.sqrt(x*x + y*y), 45), angle = Math.atan2(y, x);
            joyDir = { x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45 };
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        };
        document.getElementById('joystick-container').ontouchend = () => { joyDir = {x:0,y:0}; document.getElementById('joystick-knob').style.transform = 'translate(0,0)'; };

        // Cámara Táctil
        window.addEventListener('touchstart', e => { if(isMobile && e.touches[0].pageX > window.innerWidth/2) { touchX = e.touches[0].pageX; touchY = e.touches[0].pageY; }});
        window.addEventListener('touchmove', e => {
            if(isMobile && e.touches[0].pageX > window.innerWidth/2) {
                camera.rotation.y -= (e.touches[0].pageX - touchX) * 0.005;
                camera.rotation.x -= (e.touches[0].pageY - touchY) * 0.005;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
                touchX = e.touches[0].pageX; touchY = e.touches[0].pageY;
            }
        });
    </script>
</body>
</html>
