<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: Ultimate Survival Engine</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        #crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .ch-line { position: absolute; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 0 2px rgba(0, 0, 0, 0.5); }
        .ch-v { width: 2px; height: 100%; }
        .ch-h { width: 100%; height: 2px; }
        
        /* HUD DE VIDA */
        #hud-survival { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: none; z-index: 25; }
        .heart { width: 18px; height: 18px; background: #ff3232; border: 2px solid #000; border-radius: 2px; }
        .heart.empty { background: #333; }

        .full-overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; background: rgba(0,0,0,0.85); pointer-events: auto; }
        #m-hub { background: rgba(0,0,0,0.95); }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 8px; cursor: pointer; border-radius: 4px; width: 260px; font-weight: bold; border-bottom: 4px solid #2e7d32; }
        .btn:active { border-bottom: 0; transform: translateY(2px); }
        .btn-red { background: #f44336; border-bottom-color: #b71c1c; }
        .btn-blue { background: #2196F3; border-bottom-color: #1565C0; }
        .btn-purple { background: #9c27b0; border-bottom-color: #7b1fa2; }
        .mod-row { margin: 8px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; width: 300px; justify-content: space-between; font-size: 13px; }
        
        #creative-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 340px; height: 420px; background: #c6c6c6; border: 4px solid #373737; display: none; flex-direction: column; padding: 15px; z-index: 300; pointer-events: auto; color: #333; overflow-y: auto; }
        #creative-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .c-item { width: 65px; height: 65px; border: 3px solid #373737; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; text-align: center; font-weight: bold; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2); }
        
        .crafting-grid { display: grid; grid-template-columns: repeat(2, 55px); gap: 8px; background: #8b8b8b; padding: 10px; border: 2px solid #373737; }
        .craft-slot { width: 55px; height: 55px; background: #8b8b8b; border: 3px solid #373737; cursor: pointer; color: #fff; font-size: 10px; text-align: center; display: flex; align-items: center; justify-content: center; }
        
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        
        .m-btn { position: absolute; width: 65px; height: 65px; background: rgba(255,255,255,0.2); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid rgba(255,255,255,0.1); }
        #m-mine { bottom: 130px; right: 130px; background: rgba(255, 0, 0, 0.4); }
        #m-place { bottom: 130px; right: 40px; background: rgba(0, 120, 255, 0.4); }
        #m-jump { bottom: 40px; right: 85px; width: 100px; height: 55px; background: rgba(255,255,255,0.3); }
        #m-inv { top: 15px; left: 15px; width: 50px; height: 50px; background: #4CAF50; }
        #m-mod { top: 15px; left: 75px; width: 50px; height: 50px; background: #ff9800; }
        #m-cre { top: 80px; left: 15px; width: 50px; height: 50px; background: #2196F3; }
        
        #inventory-panel { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); width: 240px; background: #c6c6c6; border: 4px solid #373737; display: none; flex-direction: column; align-items: center; padding: 12px; z-index: 200; pointer-events: auto; }
        #craft-result { width: 60px; height: 60px; background: #999; border: 4px solid #373737; margin-top: 10px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; cursor: pointer; }
        
        #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.7); padding: 5px; border: 3px solid #555; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; background: rgba(255,255,255,0.1); cursor: pointer; }
        .slot.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
        #break-indicator { position: absolute; top: 50%; left: 50%; width: 22px; height: 22px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
    </style>
</head>
<body>
    <div id="crosshair"><div class="ch-line ch-v"></div><div class="ch-line ch-h"></div></div>
    <div id="break-indicator"></div>
    
    <div id="hud-survival"></div>

    <div id="menu" class="full-overlay" style="display: flex;">
        <h1>MINECRAFT JS: ULTIMATE SURVIVAL</h1>
        <button class="btn" onclick="startGame(false)">MODO PC (WASD + Mouse)</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR (Touch)</button>
    </div>

    <div id="m-hub" class="full-overlay">
        <h2>CENTRO DE CONTROL (M)</h2>
        <div id="mp-status" style="font-size: 11px; color: #888; margin-bottom: 8px;">Iniciando Red...</div>
        <button class="btn btn-blue" onclick="openSubMenu('mp-menu')">üåê MULTIJUGADOR P2P</button>
        <button class="btn" onclick="openSubMenu('obj-editor')">üèóÔ∏è CREAR NUEVO OBJETO</button>
        <button class="btn btn-purple" onclick="openSubMenu('ent-editor')">üëπ DISE√ëAR ENTIDAD</button>
        <button class="btn" onclick="openSubMenu('mod-menu-inner')">üöÄ MODS & CHEATS</button>
        <button class="btn btn-red" onclick="closeAllMenus()">VOLVER AL JUEGO</button>
    </div>

    <div id="ent-editor" class="full-overlay">
        <h2>CREADOR DE ENTIDADES</h2>
        <input type="text" id="ent-name" placeholder="Nombre de la entidad..." style="padding:10px; margin:5px;">
        <div class="mod-row">Color Base: <input type="color" id="ent-color" value="#228b22"></div>
        <div class="mod-row">Vida: <input type="number" id="ent-hp" value="20" style="width:50px"> ‚ù§Ô∏è</div>
        <div class="mod-row">Da√±o: <input type="number" id="ent-dmg" value="2" style="width:50px"> ‚öîÔ∏è</div>
        <div class="mod-row">Comportamiento: 
            <select id="ent-behavior">
                <option value="hostile">Hostil (Persigue)</option>
                <option value="passive">Pasivo (Huye)</option>
            </select>
        </div>
        <button class="btn btn-purple" onclick="saveCustomEntity()">üß¨ CREAR HUEVO DE SPAWN</button>
        <button class="btn btn-red" onclick="openSubMenu('m-hub')">VOLVER</button>
    </div>

    <div id="mp-menu" class="full-overlay">
        <h2>CONEXI√ìN P2P</h2>
        <div class="mod-row">Tu ID: <b id="my-code-display">...</b></div>
        <input type="text" id="join-code" placeholder="Pega ID del amigo..." style="padding:10px; margin:5px; width: 240px; text-align: center;">
        <button class="btn" onclick="joinServer()">CONECTAR A AMIGO</button>
        <button class="btn btn-red" onclick="openSubMenu('m-hub')">VOLVER</button>
    </div>

    <div id="creative-panel">
        <h3 style="margin-top:0">MODO CREATIVO (T)</h3>
        <div id="creative-list"></div>
        <button class="btn btn-red" style="width:100%; margin-top: 15px;" onclick="toggleCreative()">CERRAR</button>
    </div>

    <div id="obj-editor" class="full-overlay">
        <h2>EDITOR DE BLOQUES</h2>
        <input type="text" id="obj-name" placeholder="Nombre..." style="padding:10px; margin:5px;">
        <div class="mod-row">Color: <input type="color" id="obj-color" value="#ffffff"></div>
        <div class="mod-row">Dureza: <input type="range" id="obj-hard" min="0" max="10" step="1" value="2"></div>
        <button class="btn" onclick="saveCustomObject()">üíæ GUARDAR BLOQUE</button>
        <button class="btn btn-red" onclick="openSubMenu('m-hub')">CANCELAR</button>
    </div>

    <div id="mod-menu-inner" class="full-overlay">
        <h2>CONFIGURACI√ìN</h2>
        <div class="mod-row">Vuelo: <input type="checkbox" id="mod-fly" onchange="updateMods()"></div>
        <div class="mod-row">Velocidad: <input type="range" id="mod-speed" min="1" max="50" value="6" oninput="updateMods()"></div>
        <div class="mod-row">FOV: <input type="range" id="mod-fov" min="60" max="120" value="80" oninput="updateMods()"></div>
        <button class="btn" onclick="openSubMenu('m-hub')">VOLVER</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">GOLPE</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-inv">INV</div>
        <div class="m-btn" id="m-mod">M</div>
        <div class="m-btn" id="m-cre">T</div>
    </div>

    <div id="inventory-panel">
        <div class="crafting-grid" id="main-craft-grid">
            <div id="c0" class="craft-slot" onclick="tapToCraft(0)"></div>
            <div id="c1" class="craft-slot" onclick="tapToCraft(1)"></div>
            <div id="c2" class="craft-slot" onclick="tapToCraft(2)"></div>
            <div id="c3" class="craft-slot" onclick="tapToCraft(3)"></div>
        </div>
        <div id="craft-result" onclick="finishCraft()">CRAFTEAR</div>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div id="s0" class="slot active" data-color="null" data-count="0" onclick="updateActiveSlot(0)">1</div>
            <div id="s1" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(1)">2</div>
            <div id="s2" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(2)">3</div>
            <div id="s3" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(3)">4</div>
            <div id="s4" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(4)">5</div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        // --- ESTADO GLOBAL ---
        let blocks = [], entities = [], isMobile = false, activeSlot = 0;
        let isInventoryOpen = false, isAnyMOpen = false, isCreativeOpen = false;
        let velocityY = 0, isGrounded = false, keys = {};
        let playerHP = 10, lastDmgTime = 0;
        let config = { gravity: 28, speed: 6, fly: false, sensitivity: 0.002, fov: 80 };
        let isMining = false, mineProgress = 0, currentTarget = null;

        // --- MULTIJUGADOR ---
        let peer, connections = [], remotePlayers = {};
        const playerGeo = new THREE.BoxGeometry(0.5, 1.5, 0.5);
        const playerMat = new THREE.MeshLambertMaterial({ color: 0x0000ff });

        function initMultiplayer() {
            peer = new Peer(); 
            peer.on('open', (id) => {
                document.getElementById('mp-status').innerText = "ID: " + id;
                document.getElementById('my-code-display').innerText = id;
            });
            peer.on('connection', (conn) => setupConnection(conn));
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                connections.push(conn);
                const pMesh = new THREE.Mesh(playerGeo, playerMat);
                scene.add(pMesh);
                remotePlayers[conn.peer] = pMesh;
            });
            conn.on('data', (data) => {
                if(data.type === 'move' && remotePlayers[conn.peer]) remotePlayers[conn.peer].position.set(data.x, data.y, data.z);
                if(data.type === 'place') addBlock(data.x, data.y, data.z, data.color);
            });
        }

        window.joinServer = () => {
            const code = document.getElementById('join-code').value.trim();
            if(!code) return;
            setupConnection(peer.connect(code));
            closeAllMenus();
        };

        // --- CATALOGO & DATA ---
        let hardness = { "2e7d32": 0.5, "795548": 0.4, "5d4037": 1.5, "388e3c": 0.2, "9e9e9e": 2.5, "1a1a1a": 999 };
        const catalog = [
            {name:"Pasto", color:0x2e7d32, type:"block"},
            {name:"Tierra", color:0x795548, type:"block"},
            {name:"Madera", color:0x5d4037, type:"block"},
            {name:"Piedra", color:0x9e9e9e, type:"block"},
            {name:"Zombie", color:0x228b22, type:"spawner", entId:'default_z'}
        ];
        const entityBlueprints = {
            'default_z': { hp: 20, dmg: 1, behavior: 'hostile', color: 0x228b22 }
        };

        // --- MOTOR RENDER ---
        const scene = new THREE.Scene(); 
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(config.fov, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new PointerLockControls(camera, document.body);

        // --- MUNDO & CHUNKS ---
        const CHUNK_SIZE = 12;
        const RENDER_DISTANCE = 1; 
        const chunks = new Map();
        const blockBox = new THREE.BoxGeometry(1, 1, 1);

        function addBlock(x, y, z, color) {
            const m = new THREE.Mesh(blockBox, new THREE.MeshStandardMaterial({ color }));
            m.position.set(Math.round(x), Math.round(y), Math.round(z));
            scene.add(m);
            blocks.push(m);
            return m;
        }

        async function generateChunk(cx, cz) {
            const key = `${cx},${cz}`;
            if (chunks.has(key)) return;
            const group = new THREE.Group();
            chunks.set(key, group);
            scene.add(group);
            for(let x=0; x<CHUNK_SIZE; x++){
                for(let z=0; z<CHUNK_SIZE; z++){
                    let wx = cx*CHUNK_SIZE+x, wz = cz*CHUNK_SIZE+z;
                    let h = Math.round(Math.sin(wx/8)*2 + Math.cos(wz/8)*2);
                    let b = addBlock(wx, h, wz, 0x2e7d32);
                    group.add(b);
                }
                if(x%4===0) await new Promise(r=>setTimeout(r,0));
            }
        }

        // --- SISTEMA DE ENTIDADES (ARREGLADO) ---
        function spawnEntity(x, y, z, blueprintId) {
            const bp = entityBlueprints[blueprintId] || entityBlueprints['default_z'];
            const group = new THREE.Group();
            
            // Cuerpo S√≥lido (No transparente)
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(0.7, 1.8, 0.7),
                new THREE.MeshLambertMaterial({ color: bp.color })
            );
            group.add(body);
            
            group.position.set(x, y + 1, z);
            scene.add(group);
            entities.push({ 
                mesh: group, 
                hp: bp.hp, 
                dmg: bp.dmg, 
                behavior: bp.behavior, 
                bob: Math.random()*10 
            });
        }

        function updateSurvival(delta) {
            const pPos = camera.position;
            entities.forEach((ent, index) => {
                const ePos = ent.mesh.position;
                const dist = pPos.distanceTo(ePos);

                // COLISI√ìN Y DA√ëO
                if(dist < 1.4) {
                    // El zombie nos empuja
                    const dir = new THREE.Vector3().subVectors(pPos, ePos).normalize();
                    camera.position.addScaledVector(dir, 0.05);

                    // Recibir da√±o cada 1.2s
                    if(Date.now() - lastDmgTime > 1200) {
                        playerHP--;
                        lastDmgTime = Date.now();
                        renderHearts();
                        if(playerHP <= 0) { alert("¬°HAS MUERTO!"); location.reload(); }
                    }
                }

                // INTELIGENCIA ARTIFICIAL
                if(ent.behavior === 'hostile' && dist < 16 && dist > 1.2) {
                    const dir = new THREE.Vector3().subVectors(pPos, ePos).normalize();
                    ePos.x += dir.x * 3 * delta;
                    ePos.z += dir.z * 3 * delta;
                    ent.mesh.lookAt(pPos.x, ePos.y, pPos.z);
                    ent.mesh.position.y = (Math.round(ePos.y)) + Math.abs(Math.sin(ent.bob += delta*10))*0.2;
                }
            });
        }

        function renderHearts() {
            const h = document.getElementById('hud-survival');
            h.innerHTML = '';
            for(let i=0; i<10; i++) {
                const heart = document.createElement('div');
                heart.className = `heart ${i >= playerHP ? 'empty' : ''}`;
                h.appendChild(heart);
            }
        }

        // --- COMBATE ---
        function handleAttack() {
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(entities.map(e => e.mesh), true);
            
            if(hits.length > 0 && hits[0].distance < 4) {
                const target = entities.find(e => e.mesh === hits[0].object.parent || e.mesh === hits[0].object);
                if(target) {
                    target.hp -= 5;
                    hits[0].object.material.emissive.setHex(0xff0000);
                    setTimeout(() => { if(hits[0].object.material) hits[0].object.material.emissive.setHex(0x000000); }, 150);
                    
                    if(target.hp <= 0) {
                        scene.remove(target.mesh);
                        entities = entities.filter(e => e !== target);
                    }
                }
            }
        }

        // --- LOOP PRINCIPAL ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);
            
            // Cargar terrenos
            const cx = Math.floor(camera.position.x/CHUNK_SIZE);
            const cz = Math.floor(camera.position.z/CHUNK_SIZE);
            generateChunk(cx, cz);
            generateChunk(cx+1, cz); generateChunk(cx-1, cz);
            generateChunk(cx, cz+1); generateChunk(cx, cz-1);

            updateSurvival(delta);

            // MOVIMIENTO
            if(controls.isLocked || isMobile) {
                if(!config.fly) {
                    velocityY -= config.gravity * delta;
                    camera.position.y += velocityY * delta;
                    if(camera.position.y < 2) { camera.position.y = 2; velocityY = 0; isGrounded = true; } else isGrounded = false;
                }

                const move = new THREE.Vector3();
                if(isMobile) { move.z = -joyDir.y; move.x = joyDir.x; }
                else {
                    if(keys['KeyW']) move.z += 1; if(keys['KeyS']) move.z -= 1;
                    if(keys['KeyA']) move.x -= 1; if(keys['KeyD']) move.x += 1;
                }
                
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
                const side = new THREE.Vector3().crossVectors(dir, camera.up).normalize();
                camera.position.addScaledVector(dir, move.z * config.speed * delta);
                camera.position.addScaledVector(side, move.x * config.speed * delta);
            }

            if(connections.length > 0) {
                connections.forEach(c => c.send({type:'move', x:camera.position.x, y:camera.position.y, z:camera.position.z}));
            }

            renderer.render(scene, camera);
        }

        // --- UI & EVENTOS ---
        window.startGame = (m) => {
            isMobile = m;
            document.getElementById('menu').style.display='none';
            if(m) document.getElementById('mobile-controls').style.display='block';
            else controls.lock();
            initMultiplayer();
            renderHearts();
            scene.add(new THREE.AmbientLight(0xffffff, 0.7), new THREE.DirectionalLight(0xffffff, 0.4));
            animate();
        };

        window.saveCustomEntity = () => {
            const id = 'ent_' + Date.now();
            entityBlueprints[id] = {
                hp: parseInt(document.getElementById('ent-hp').value),
                dmg: parseInt(document.getElementById('ent-dmg').value),
                behavior: document.getElementById('ent-behavior').value,
                color: parseInt(document.getElementById('ent-color').value.replace('#','0x'))
            };
            catalog.push({name: "Huevo "+document.getElementById('ent-name').value, color: entityBlueprints[id].color, type:"spawner", entId: id});
            openSubMenu('m-hub');
        };

        window.handlePlace = () => {
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks);
            if(hits.length > 0 && hits[0].distance < 5) {
                const s = document.querySelectorAll('.slot')[activeSlot];
                if(s.dataset.color !== "null") {
                    const pos = hits[0].object.position.clone().add(hits[0].face.normal);
                    if(s.dataset.type === "spawner") {
                        spawnEntity(pos.x, pos.y, pos.z, s.dataset.entid);
                    } else {
                        addBlock(pos.x, pos.y, pos.z, parseInt(s.dataset.color));
                        connections.forEach(c => c.send({type:'place', x:pos.x, y:pos.y, z:pos.z, color:parseInt(s.dataset.color)}));
                    }
                }
            }
        };

        // --- JOYSTICK ---
        let joyDir = {x:0, y:0};
        document.getElementById('joystick-container').ontouchmove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
            const dist = Math.min(Math.sqrt(x*x+y*y), 45), angle = Math.atan2(y,x);
            joyDir = {x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45};
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        };
        document.getElementById('joystick-container').ontouchend = () => { joyDir={x:0,y:0}; document.getElementById('joystick-knob').style.transform='translate(0,0)'; };

        // --- TECLAS & OTROS ---
        window.addEventListener('keydown', e => { 
            keys[e.code] = true;
            if(e.key === 'm') isAnyMOpen ? closeAllMenus() : openSubMenu('m-hub');
            if(e.key === 't') toggleCreative();
            if(e.key === 'e') toggleInventory();
            if(e.code === 'Space' && isGrounded) velocityY = 12;
            if(['1','2','3','4','5'].includes(e.key)) updateActiveSlot(parseInt(e.key)-1);
        });
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('mousedown', e => { if(controls.isLocked) e.button===0 ? handleAttack() : handlePlace(); });

        window.openSubMenu = (id) => { document.querySelectorAll('.full-overlay').forEach(el=>el.style.display='none'); document.getElementById(id).style.display='flex'; isAnyMOpen=true; controls.unlock(); };
        window.closeAllMenus = () => { document.querySelectorAll('.full-overlay').forEach(el=>el.style.display='none'); isAnyMOpen=false; if(!isMobile) controls.lock(); };
        window.updateActiveSlot = (i) => { activeSlot = i; document.querySelectorAll('.slot').forEach((s,idx)=>s.classList.toggle('active', idx===i)); };
        window.toggleCreative = () => { isCreativeOpen = !isCreativeOpen; document.getElementById('creative-panel').style.display = isCreativeOpen ? 'flex' : 'none'; renderCreativeList(); };
        
        function renderCreativeList() {
            const list = document.getElementById('creative-list'); list.innerHTML = "";
            catalog.forEach(item => {
                const div = document.createElement('div'); div.className = 'c-item';
                div.style.backgroundColor = "#" + item.color.toString(16).padStart(6,'0');
                div.innerText = item.name;
                div.onclick = () => {
                    const s = document.querySelectorAll('.slot')[activeSlot];
                    s.dataset.color = item.color; s.dataset.type = item.type; s.dataset.entid = item.entId || '';
                    s.style.backgroundColor = div.style.backgroundColor;
                };
                list.appendChild(div);
            });
        }

        window.updateMods = () => {
            config.speed = parseInt(document.getElementById('mod-speed').value);
            config.fly = document.getElementById('mod-fly').checked;
            camera.fov = parseInt(document.getElementById('mod-fov').value);
            camera.updateProjectionMatrix();
        };

        // Soporte m√≥vil botones
        document.getElementById('m-mine').onclick = handleAttack;
        document.getElementById('m-place').onclick = handlePlace;
        document.getElementById('m-jump').onclick = () => { if(isGrounded) velocityY = 12; };
        document.getElementById('m-inv').onclick = () => { isInventoryOpen = !isInventoryOpen; document.getElementById('inventory-panel').style.display = isInventoryOpen ? 'flex' : 'none'; };
        document.getElementById('m-mod').onclick = () => openSubMenu('m-hub');
        document.getElementById('m-cre').onclick = toggleCreative;

    </script>
</body>
</html>
