<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft JS: THE EVERYTHING EDITION</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', monospace; background: #000; user-select: none; touch-action: none; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        
        /* --- TODOS LOS MENÚS --- */
        #menu, #esc-menu, #obj-editor, #mod-menu { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; pointer-events: auto; }
        #menu { background: rgba(0,0,0,0.95); }
        #esc-menu, #mod-menu { background: rgba(0,0,0,0.85); display: none; }
        #obj-editor { background: #1a1a1a; display: none; padding: 20px; border: 4px solid #4CAF50; overflow-y: auto; text-align: center; }

        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; font-size: 14px; margin: 5px; cursor: pointer; border-radius: 4px; width: 230px; font-weight: bold; }
        .mod-row { margin: 10px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; width: 250px; justify-content: space-between; font-size: 13px; }

        /* --- CONTROLES MÓVILES COMPLETOS --- */
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        
        .m-btn { position: absolute; width: 65px; height: 65px; background: rgba(255,255,255,0.2); border-radius: 15px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid rgba(255,255,255,0.1); }
        #m-mine { bottom: 130px; right: 130px; background: rgba(255, 0, 0, 0.3); }
        #m-place { bottom: 130px; right: 40px; background: rgba(0, 120, 255, 0.3); }
        #m-jump { bottom: 40px; right: 85px; width: 100px; height: 55px; background: rgba(255,255,255,0.3); }
        #m-inv { top: 15px; left: 15px; width: 50px; height: 50px; background: #4CAF50; }
        #m-mod { top: 15px; left: 75px; width: 50px; height: 50px; background: #ff9800; }
        #m-esc { top: 15px; right: 15px; width: 50px; height: 50px; background: #555; }

        /* --- INVENTARIO Y CRAFTEO --- */
        #inventory-panel { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); width: 240px; background: #c6c6c6; border: 4px solid #373737; display: none; flex-direction: column; align-items: center; padding: 12px; z-index: 200; pointer-events: auto; box-shadow: 0 10px 0 #555; }
        .crafting-grid { display: grid; grid-template-columns: repeat(2, 55px); gap: 8px; background: #8b8b8b; padding: 10px; border: 2px solid #373737; }
        .craft-slot { width: 55px; height: 55px; background: #8b8b8b; border: 3px solid #373737; cursor: pointer; }
        #craft-result { width: 60px; height: 60px; background: #999; border: 4px solid #373737; margin-top: 12px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; cursor: pointer; color: #fff; text-shadow: 1px 1px #000; }

        /* --- UI DEL JUEGO --- */
        #hotbar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.7); padding: 5px; border: 3px solid #555; pointer-events: auto; }
        .slot { width: 45px; height: 45px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; background: rgba(255,255,255,0.1); font-weight: bold; }
        .slot.active { border-color: #fff; box-shadow: 0 0 10px #fff; background: rgba(255,255,255,0.2); }
        #damage-flash { position: fixed; inset: 0; background: rgba(255,0,0,0); pointer-events: none; z-index: 1000; transition: background 0.1s; }
        #break-indicator { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.5); transform: translate(-50%, -50%); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="damage-flash"></div>
    <div id="break-indicator"></div>
    <div id="crosshair"></div>

    <div id="menu">
        <h1>MINECRAFT JS <small style="font-size: 12px;">ULTIMATE</small></h1>
        <button class="btn" onclick="startGame(false)">MODO PC</button>
        <button class="btn" onclick="startGame(true)">MODO CELULAR</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div class="m-btn" id="m-mine">MINAR</div>
        <div class="m-btn" id="m-place">PONER</div>
        <div class="m-btn" id="m-jump">SALTAR</div>
        <div class="m-btn" id="m-inv">INV</div>
        <div class="m-btn" id="m-mod">M</div>
        <div class="m-btn" id="m-esc">ESC</div>
    </div>

    <div id="mod-menu">
        <h2>MODS ACTIVOS</h2>
        <div class="mod-row">Gravedad: <input type="range" id="mod-grav" min="0" max="50" value="25" oninput="updateMods()"></div>
        <div class="mod-row">Velocidad: <input type="range" id="mod-speed" min="1" max="30" value="6" oninput="updateMods()"></div>
        <div class="mod-row">Cielo: <input type="color" id="mod-sky" value="#87ceeb" oninput="updateMods()"></div>
        <div class="mod-row">Modo Vuelo: <input type="checkbox" id="mod-fly" onchange="updateMods()"></div>
        <button class="btn" onclick="toggleModMenu()">CERRAR [M]</button>
    </div>

    <div id="inventory-panel">
        <div class="crafting-grid">
            <div id="c0" class="craft-slot" onclick="tapToCraft(0)"></div>
            <div id="c1" class="craft-slot" onclick="tapToCraft(1)"></div>
            <div id="c2" class="craft-slot" onclick="tapToCraft(2)"></div>
            <div id="c3" class="craft-slot" onclick="tapToCraft(3)"></div>
        </div>
        <div id="craft-result" onclick="finishCraft()">CRAFTEAR</div>
    </div>

    <div id="esc-menu">
        <h2>PAUSA</h2>
        <button class="btn" onclick="toggleEscMenu()">REANUDAR</button>
        <button class="btn" onclick="openEditor()">EDITOR DE BLOQUES</button>
        <button class="btn" onclick="location.reload()">REINICIAR MUNDO</button>
    </div>

    <div id="obj-editor">
        <h3>EDITOR DE OBJETO</h3>
        <input type="text" id="obj-name" placeholder="Nombre del bloque..." style="padding: 8px; margin-bottom: 10px;">
        <div>Color: <input type="color" id="obj-color" value="#ff00ff"></div>
        <p style="font-size: 11px;">Receta necesaria:</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin:10px;">
            <button class="btn" style="width:100px; font-size:10px;" onclick="cycleMaterial(this)" data-mat="null">VACÍO</button>
            <button class="btn" style="width:100px; font-size:10px;" onclick="cycleMaterial(this)" data-mat="null">VACÍO</button>
            <button class="btn" style="width:100px; font-size:10px;" onclick="cycleMaterial(this)" data-mat="null">VACÍO</button>
            <button class="btn" style="width:100px; font-size:10px;" onclick="cycleMaterial(this)" data-mat="null">VACÍO</button>
        </div>
        <button class="btn" onclick="saveNewObject()">GUARDAR RECETA</button>
    </div>

    <div id="ui-layer">
        <div id="hotbar">
            <div id="s0" class="slot active" data-color="null" data-count="0" onclick="updateActiveSlot(0)">1</div>
            <div id="s1" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(1)">2</div>
            <div id="s2" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(2)">3</div>
            <div id="s3" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(3)">4</div>
            <div id="s4" class="slot" data-color="null" data-count="0" onclick="updateActiveSlot(4)">5</div>
        </div>
    </div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        let blocks = [], isMobile = false, activeSlot = 0;
        let isInventoryOpen = false, isEscMenuOpen = false, isModMenuOpen = false;
        let velocityY = 0, isGrounded = false, fallStartY = 0;
        let joyDir = { x: 0, y: 0 }, touchX = 0, touchY = 0, keys = {};
        
        // --- CONFIGURACIÓN DE FIX (FOV Y SENSIBILIDAD) ---
        let config = { gravity: 25, speed: 6, fly: false, sensitivity: 0.002, fov: 85 };
        
        // --- SISTEMA DE MINADO ---
        let isMining = false, mineProgress = 0, currentTarget = null, originalPos = new THREE.Vector3();
        const hardness = { "2e7d32": 0.6, "5d4037": 1.2, "388e3c": 0.3, "795548": 0.6, "9e9e9e": 2.5, "1a1a1a": Infinity };
        let customItem = { color: 0xff00ff, recipe: [] };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(config.fov, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new PointerLockControls(camera, document.body);

        function addBlock(x, y, z, color) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color }));
            m.position.set(x, y, z); scene.add(m); blocks.push(m);
        }

        // Mundo con Árboles y capas
        for(let x=-9; x<9; x++) {
            for(let z=-9; z<9; z++) {
                const h = Math.round(Math.sin(x/4)*Math.cos(z/4));
                addBlock(x, h, z, 0x2e7d32); // Pasto
                addBlock(x, h-1, z, 0x795548); // Tierra
                addBlock(x, -5, z, 0x1a1a1a); // Bedrock
                if(Math.random()>0.96) { // Árboles
                    for(let i=1; i<=3; i++) addBlock(x, h+i, z, 0x5d4037);
                    for(let lx=-1; lx<=1; lx++) for(let lz=-1; lz<=1; lz++) addBlock(x+lx, h+4, z+lz, 0x388e3c);
                }
            }
        }
        scene.add(new THREE.AmbientLight(0xffffff, 0.7), new THREE.DirectionalLight(0xffffff, 0.5));
        camera.position.set(0, 5, 0);

        // --- MOTOR DE COLISIONES SÓLIDAS ---
        function checkCollisions(pos) {
            if(config.fly) return false;
            const pBox = new THREE.Box3().setFromCenterAndSize(
                new THREE.Vector3(pos.x, pos.y - 0.9, pos.z),
                new THREE.Vector3(0.6, 1.8, 0.6)
            );
            for(let b of blocks) {
                if(pBox.intersectsBox(new THREE.Box3().setFromObject(b))) return true;
            }
            return false;
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);

            // Mecánica de Minado (Romper)
            if(isMining) {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects(blocks);
                if(hits.length > 0 && hits[0].distance < 4.5) {
                    const b = hits[0].object;
                    const hex = b.material.color.getHexString().toLowerCase();
                    if(hardness[hex] !== Infinity) {
                        if(currentTarget !== b) { currentTarget = b; originalPos.copy(b.position); mineProgress = 0; }
                        mineProgress += delta;
                        b.position.x = originalPos.x + (Math.random()-0.5)*0.15; // Vibración fuerte
                        document.getElementById('break-indicator').style.display='block';
                        if(mineProgress >= (hardness[hex] || 1)) {
                            addToInventory(b.material.color.getHex());
                            scene.remove(b); blocks = blocks.filter(x => x !== b); resetMining();
                        }
                    }
                } else resetMining();
            }

            if((controls.isLocked || isMobile) && !isInventoryOpen && !isEscMenuOpen && !isModMenuOpen) {
                if(!config.fly) velocityY -= config.gravity * delta;
                
                const moveVec = new THREE.Vector3();
                if(isMobile) { moveVec.z = -joyDir.y; moveVec.x = joyDir.x; }
                else {
                    if(keys['KeyW']) moveVec.z += 1; if(keys['KeyS']) moveVec.z -= 1;
                    if(keys['KeyA']) moveVec.x -= 1; if(keys['KeyD']) moveVec.x += 1;
                }

                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
                const right = new THREE.Vector3().crossVectors(dir, camera.up).normalize();

                // Colisión Eje X/Z Independiente (Sólido)
                const nextX = camera.position.clone().addScaledVector(dir, moveVec.z * config.speed * delta).addScaledVector(right, moveVec.x * config.speed * delta);
                if(!checkCollisions(new THREE.Vector3(nextX.x, camera.position.y, camera.position.z))) camera.position.x = nextX.x;
                if(!checkCollisions(new THREE.Vector3(camera.position.x, camera.position.y, nextX.z))) camera.position.z = nextX.z;

                if(!config.fly) {
                    const nextY = camera.position.clone(); nextY.y += velocityY * delta;
                    if(!checkCollisions(nextY)) {
                        camera.position.y = nextY.y; isGrounded = false;
                    } else {
                        if(velocityY < 0) { // Impacto contra suelo
                            if(fallStartY - camera.position.y > 4.5) {
                                document.getElementById('damage-flash').style.background = 'rgba(255,0,0,0.5)';
                                setTimeout(()=> document.getElementById('damage-flash').style.background = 'transparent', 120);
                            }
                            isGrounded = true; fallStartY = camera.position.y;
                        }
                        velocityY = 0;
                    }
                } else {
                    const flyV = (keys['Space'] ? 0.2 : 0) - (keys['ShiftLeft'] ? 0.2 : 0);
                    camera.position.y += flyV;
                }
            }
            renderer.render(scene, camera);
        }

        // --- SISTEMAS DE INTERACCIÓN (PONER BLOQUES) ---
        window.handlePlace = () => {
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
            const hits = ray.intersectObjects(blocks);
            if(hits.length > 0 && hits[0].distance < 5) {
                const s = document.querySelectorAll('.slot')[activeSlot];
                if(s.dataset.color !== "null") {
                    const pos = hits[0].object.position.clone().add(hits[0].face.normal);
                    // No colocar sobre el jugador
                    const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(camera.position.x, camera.position.y-0.9, camera.position.z), new THREE.Vector3(0.6, 1.8, 0.6));
                    const bBox = new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(1,1,1));
                    if(!pBox.intersectsBox(bBox)) {
                        addBlock(pos.x, pos.y, pos.z, parseInt(s.dataset.color));
                        let count = parseInt(s.dataset.count) - 1;
                        s.dataset.count = count; s.innerText = count > 0 ? count : activeSlot+1;
                        if(count <= 0) { s.dataset.color = "null"; s.style.backgroundColor = "rgba(255,255,255,0.1)"; }
                    }
                }
            }
        };

        function addToInventory(color) {
            const slots = document.querySelectorAll('.slot');
            let t = Array.from(slots).find(s => parseInt(s.dataset.color) === color) || Array.from(slots).find(s => s.dataset.color === "null");
            if(t) {
                let c = (parseInt(t.dataset.count) || 0) + 1;
                t.dataset.color = color; t.dataset.count = c;
                t.style.backgroundColor = "#" + color.toString(16).padStart(6,'0');
                t.innerText = c;
            }
        }

        function resetMining() { if(currentTarget) currentTarget.position.copy(originalPos); isMining = false; document.getElementById('break-indicator').style.display='none'; }

        // --- MENÚS Y LÓGICA ---
        window.startGame = (m) => { isMobile = m; document.getElementById('menu').style.display='none'; if(m) document.getElementById('mobile-controls').style.display='block'; else controls.lock(); animate(); };
        window.toggleModMenu = () => { isModMenuOpen = !isModMenuOpen; document.getElementById('mod-menu').style.display = isModMenuOpen ? 'flex' : 'none'; };
        window.toggleInventory = () => { isInventoryOpen = !isInventoryOpen; document.getElementById('inventory-panel').style.display = isInventoryOpen ? 'flex' : 'none'; };
        window.toggleEscMenu = () => { isEscMenuOpen = !isEscMenuOpen; document.getElementById('esc-menu').style.display = isEscMenuOpen ? 'flex' : 'none'; if(!isMobile) isEscMenuOpen ? controls.unlock() : controls.lock(); };
        window.updateMods = () => {
            config.gravity = parseFloat(document.getElementById('mod-grav').value);
            config.speed = parseFloat(document.getElementById('mod-speed').value);
            config.fly = document.getElementById('mod-fly').checked;
            scene.background = new THREE.Color(document.getElementById('mod-sky').value);
        };
        window.updateActiveSlot = (i) => { activeSlot = i; document.querySelectorAll('.slot').forEach((s,idx) => s.classList.toggle('active', idx === i)); };
        
        // Crafting e Inventario
        window.tapToCraft = (idx) => {
            const s = document.querySelectorAll('.slot')[activeSlot];
            if(s.dataset.color !== "null") {
                const el = document.getElementById('c'+idx);
                el.style.backgroundColor = s.style.backgroundColor; el.dataset.color = s.dataset.color;
            }
        };
        window.finishCraft = () => {
            document.querySelectorAll('.craft-slot').forEach(s => { s.style.backgroundColor="#8b8b8b"; s.dataset.color="null"; });
            addToInventory(customItem.color);
        };
        window.openEditor = () => document.getElementById('obj-editor').style.display='flex';
        window.saveNewObject = () => { 
            customItem.color = parseInt("0x"+document.getElementById('obj-color').value.replace('#','')); 
            document.getElementById('obj-editor').style.display = 'none'; 
        };
        window.cycleMaterial = (el) => {
            const mats = [{n:"VACÍO",c:"null"}, {n:"PASTO",c:"2e7d32"}, {n:"MADERA",c:"5d4037"}, {n:"PIEDRA",c:"9e9e9e"}];
            let idx = mats.findIndex(m => m.c === el.getAttribute("data-mat"));
            let next = mats[(idx + 1) % mats.length];
            el.setAttribute("data-mat", next.c); el.innerText = next.n;
        };

        // --- EVENTOS TÁCTILES ---
        window.addEventListener('touchstart', e => { if(isMobile && e.touches[0].pageX > window.innerWidth/2) { touchX = e.touches[0].pageX; touchY = e.touches[0].pageY; }});
        window.addEventListener('touchmove', e => {
            if(isMobile && !isInventoryOpen && !isEscMenuOpen && !isModMenuOpen && e.touches[0].pageX > window.innerWidth/2) {
                // Sensibilidad reducida aplicada
                camera.rotation.y -= (e.touches[0].pageX - touchX) * config.sensitivity;
                camera.rotation.x -= (e.touches[0].pageY - touchY) * config.sensitivity;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
                touchX = e.touches[0].pageX; touchY = e.touches[0].pageY;
            }
        });
        document.getElementById('joystick-container').addEventListener('touchmove', e => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 55, y = e.touches[0].clientY - rect.top - 55;
            const dist = Math.min(Math.sqrt(x*x + y*y), 45), angle = Math.atan2(y, x);
            joyDir = { x: (Math.cos(angle)*dist)/45, y: (Math.sin(angle)*dist)/45 };
            document.getElementById('joystick-knob').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        });
        document.getElementById('joystick-container').addEventListener('touchend', () => { joyDir = {x:0,y:0}; document.getElementById('joystick-knob').style.transform = 'translate(0,0)'; });

        // Botones Celular
        document.getElementById('m-mine').ontouchstart = (e) => { e.preventDefault(); isMining = true; };
        document.getElementById('m-mine').ontouchend = resetMining;
        document.getElementById('m-place').onclick = handlePlace;
        document.getElementById('m-jump').onclick = () => { if(isGrounded || config.fly) velocityY = 11; };
        document.getElementById('m-mod').onclick = toggleModMenu;
        document.getElementById('m-inv').onclick = toggleInventory;
        document.getElementById('m-esc').onclick = toggleEscMenu;

        // PC Events
        window.addEventListener('mousedown', (e) => { if(controls.isLocked) { if(e.button === 0) isMining = true; if(e.button === 2) handlePlace(); }});
        window.addEventListener('mouseup', () => resetMining());
        window.addEventListener('keydown', e => { 
            keys[e.code] = true; 
            if(e.key.toLowerCase()==='m') toggleModMenu(); 
            if(e.key.toLowerCase()==='e') toggleInventory();
            if(e.code==='Space' && (isGrounded || config.fly)) velocityY = 11;
        });
        window.addEventListener('keyup', e => keys[e.code] = false);
    </script>
</body>
</html>
